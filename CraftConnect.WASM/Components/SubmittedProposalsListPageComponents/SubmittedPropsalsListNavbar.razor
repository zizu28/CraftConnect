@using Core.SharedKernel.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager

<nav class="top-nav-bar">
    <div class="nav-left">
        <a href="/" class="logo-container">
            <img src="/images/craftconnect-logo.png" alt="CraftConnect Logo" class="brand-logo-img" />
            <span class="logo-text">CraftConnect</span>
        </a>
        <div class="nav-links">
            <NavLink href="/projects" Match="NavLinkMatch.Prefix">Projects</NavLink>
            <NavLink href=@($"/customer/{CraftsmanId}/messages") Match="NavLinkMatch.Prefix">Messages</NavLink>
            <NavLink href=@($"/dashboard/{CraftsmanId}") Match="NavLinkMatch.Prefix">Profile</NavLink>
        </div>
    </div>
    <div class="nav-right">
        <div class="global-search-container">
            <i class="bi bi-search global-search-icon"></i>
            <input class="global-search-input" type="text" placeholder="Search" />
        </div>
        <div class="user-actions">
            <!-- Greeting -->
            <span class="user-greeting">Hi, <strong>@DisplayName</strong></span>

            <!-- Profile Avatar -->
            <a href="/profile" class="profile-icon-link" title="My Profile">
                <div class="profile-icon">
                    <img src="@CraftsmanImageUrl" alt="Profile" class="profile-image" />
                </div>
            </a>

            <!-- Logout Button -->
            <button class="btn-logout" @onclick="HandleLogout" title="Log out">
                <i class="bi bi-box-arrow-right"></i>
            </button>

            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-button" @onclick="ToggleMobileMenu">
                <i class="bi @(isMobileMenuOpen ? "bi-x-lg" : "bi-list")"></i>
            </button>
        </div>
    </div>
</nav>

<!-- Mobile Menu (hidden by default) -->
@if (isMobileMenuOpen)
{
    <div class="mobile-menu">
        <NavLink href="/projects" Match="NavLinkMatch.Prefix">Projects</NavLink>
        <NavLink href="/customer/messages" Match="NavLinkMatch.Prefix">Messages</NavLink>
        <NavLink href="/dashboard" Match="NavLinkMatch.Prefix">Profile</NavLink>
        <button class="mobile-logout-link" @onclick="HandleLogout">
            <i class="bi bi-box-arrow-right me-2"></i> Log out
        </button>
    </div>
}

@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthenticationState { get; set; } = default!;

    // [Parameter]
    // public Guid CustomerId { get; set; } // Pass from parent if available

    private Guid CraftsmanId { get; set; }
    private string CraftsmanImageUrl { get; set; } = "/images/user-avatar.jpg";
    private string DisplayName { get; set; } = "User";
    private bool isMobileMenuOpen = false;    private string? UserEmail { get; set; }

    private void ToggleMobileMenu() => isMobileMenuOpen = !isMobileMenuOpen;

    override protected async Task OnInitializedAsync()
    {
        var authState = await AuthenticationState;
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            var nameClaim = user.FindFirst(ClaimTypes.Name)?.Value;

            // Set Display Name
            if (!string.IsNullOrEmpty(nameClaim))
            {
                DisplayName = nameClaim.Contains("@") ? nameClaim.Split('@')[0] : nameClaim;
            }

            if (Guid.TryParse(userIdClaim, out var id))
            {
                CraftsmanId = id;
                await LoadProfileImage();
            }
        }
    }

    private async Task LoadProfileImage()
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("BFF");
            var response = await httpClient.GetFromJsonAsync<CraftmanResponseDTO>($"/users/craftsman/{CraftsmanId}");

            if (response != null)
            {
                CraftsmanImageUrl = GetOptimizedUrl(response.ProfileImageUrl);
                if (!string.IsNullOrEmpty(response.FirstName)) DisplayName = response.FirstName;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load navbar image: {ex.Message}");
        }
    }

    private async Task HandleLogout()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("BFF");
            await client.PostAsync("/api/auth/logout", null);
            NavigationManager.NavigateTo("/login");
        }
        catch 
        { 
            NavigationManager.NavigateTo("/login"); 
        }
    }

    private string GetOptimizedUrl(string? originalUrl)
    {
        if (string.IsNullOrEmpty(originalUrl)) return "/images/default-avatar.png";
        return originalUrl.Replace("/upload/", "/upload/w_40,h_40,c_fill,g_face,q_auto,f_auto/");
    }
}
