@using CraftConnect.WASM.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IHttpClientFactory HttpClientFactory

<nav class="top-nav-bar">
    <div class="nav-left">
        <a href="/" class="logo-container">
            <img src="/images/craftconnect-logo.png" alt="CraftConnect Logo" class="brand-logo-img" />
            <span class="logo-text">CraftConnect</span>
        </a>
        <div class="nav-links">
            <NavLink href="/projects" Match="NavLinkMatch.Prefix">Projects</NavLink>
            <NavLink href="/customer/messages" Match="NavLinkMatch.Prefix">Messages</NavLink>
            <NavLink href=@($"/dashboard/{CraftsmanId}") Match="NavLinkMatch.Prefix">Profile</NavLink>
        </div>
    </div>
    <div class="nav-right">
        <div class="global-search-container">
            <svg class="global-search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
            </svg>
            <input class="global-search-input" type="text" placeholder="Search" />
        </div>
        <a href="/profile" class="profile-icon-link">
            <div class="profile-icon">
                @if (!string.IsNullOrEmpty(CraftsmanImageUrl))
                {
                    <img src="@CraftsmanImageUrl" alt="Profile" class="profile-image" />
                }
                else
                {
                    <!-- Optional: Show initials or default icon while loading -->
                    <span class="loading-placeholder"></span>
                }
            </div>
        </a>
    </div>
</nav>

<!-- Mobile Menu (hidden by default) -->
@if (isMobileMenuOpen)
{
    <div class="mobile-menu">
        <NavLink href="/projects" Match="NavLinkMatch.Prefix">Projects</NavLink>
        <NavLink href="/customer/messages" Match="NavLinkMatch.Prefix">Messages</NavLink>
        <NavLink href="/dashboard" Match="NavLinkMatch.Prefix">Profile</NavLink>
    </div>
}

@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthenticationState { get; set; }

    private Guid CraftsmanId { get; set; }
    private string CraftsmanImageUrl { get; set; } = "/images/user-avatar.jpg";

    private bool isMobileMenuOpen = false;

    private void ToggleMobileMenu()
    {
        isMobileMenuOpen = !isMobileMenuOpen;
    }

    override protected async Task OnInitializedAsync()
    {
        var authState = await AuthenticationState;
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (Guid.TryParse(userIdClaim, out var craftsmanId))
            {
                CraftsmanId = craftsmanId;

                await LoadProfileImage();
            }
        }
    }

    private async Task LoadProfileImage()
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("BFF");
             var response = await httpClient.GetFromJsonAsync<CraftmanResponseDTO>($"/users/craftsman/{CraftsmanId}");

            if (response != null)
            {
                CraftsmanImageUrl = GetOptimizedUrl(response.ProfileImageUrl);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load navbar image: {ex.Message}");
        }
    }

    private string GetOptimizedUrl(string? originalUrl)
    {
        if (string.IsNullOrEmpty(originalUrl)) return "/images/default-avatar.png";
        return originalUrl.Replace("/upload/", "/upload/w_40,h_40,c_fill,g_face,q_auto,f_auto/");
    }
}
