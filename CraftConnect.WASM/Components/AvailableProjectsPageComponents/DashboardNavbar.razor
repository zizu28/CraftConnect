@using Core.SharedKernel.DTOs
@using CraftConnect.WASM.Services
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject ThemeService ThemeService
@implements IDisposable
@inject NavigationManager NavigationManager
@inject IHttpClientFactory HttpClientFactory
@inject ILoggerFactory LoggerFactory

<header class="navbar-container dashboard-nav">
    <div class="navbar-content">
        <a href="/" class="brand-logo">
            <img src="/images/craftconnect-logo.png" alt="CraftConnect Logo" />
            CraftConnect
        </a>

        <button class="hamburger-btn" @onclick="ToggleMenu">
            <i class="bi bi-list"></i>
        </button>

        <nav class="nav-links @(isMenuOpen ? "open" : "")">
            @* <button class="btn theme-toggle-btn" @onclick="ThemeService.ToggleTheme" title="Toggle Theme">
                <i class="bi @(ThemeService.CurrentTheme == "light" ? "bi-moon" : "bi-sun")"></i>
            </button> *@

            <a href=@(userRole == "Customer" ? $"/customer/{UserId}/dashboard" : $"/dashboard/{UserId}") class="nav-link">Dashboard</a>
            <a href="/profile" class="nav-link">Profile</a>
            <a href="/customer/messages" class="nav-link">Messages</a>

            <!-- --- NEW USER ACTIONS SECTION --- -->
            <div class="user-actions">
                <span class="user-greeting">Welcome, <strong>@DisplayName</strong></span>

                <button class="btn btn-logout" @onclick="HandleLogout" title="Log out">
                    <i class="bi bi-box-arrow-right"></i>
                </button>

                <a href=@($"/customer/{UserId}/post-project") class="btn btn-primary btn-post-project">Post a Project</a>

                <a href="/profile" class="profile-avatar-link">
                    <img src="@GetOptimizedUrl(AvatarUrl)" alt="User Avatar" class="profile-avatar" />
                </a>
            </div>
        </nav>
    </div>
</header>

@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    private ILogger Logger => LoggerFactory.CreateLogger<DashboardNavbar>();

    private Guid UserId { get; set; }
    private string userRole = string.Empty;
    private string DisplayName { get; set; } = "User"; // Default
    private string AvatarUrl { get; set; } = "/images/user-avatar.jpg";
    private bool isMenuOpen = false;

    private void ToggleMenu() => isMenuOpen = !isMenuOpen;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateTask;
        var user = authState.User;

        if (user.Identity == null || !user.Identity.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (string.IsNullOrEmpty(userIdClaim))
        {
            NavigationManager.NavigateTo("/login");
            return;
        }
        var userEmail = user.FindFirst(ClaimTypes.Name)?.Value ?? "User";
        UserId = Guid.Parse(userIdClaim);
        userRole = user.FindFirst(ClaimTypes.Role)?.Value
           ?? user.FindFirst("role")?.Value
           ?? "";
        bool isCustomer = userRole.Equals("Customer", StringComparison.OrdinalIgnoreCase);
        bool isCraftsman = userRole.Equals("Craftman", StringComparison.OrdinalIgnoreCase);
        if (!string.IsNullOrEmpty(userEmail))
        {
            // If name is full email, just take the part before @
            DisplayName = userEmail.Split('@')[0];
        }

        try
        {
            var client = HttpClientFactory.CreateClient("BFF");
            if (isCustomer)
            {
                var customer = await client.GetFromJsonAsync<CustomerResponseDTO>($"/users/customer/{UserId}");
                if (customer != null)
                {
                    AvatarUrl = customer.ProfileImageUrl;
                }
            }
            else if (isCraftsman)
            {
                var craftsman = await client.GetFromJsonAsync<CraftmanResponseDTO>($"/users/craftsman/{UserId}");
                if (craftsman != null)
                {
                    AvatarUrl = craftsman.ProfileImageUrl;
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Error initializing navbar for user {UserId}: {ex.Message}");
        }

        ThemeService.OnThemeChanged += OnThemeChangedHandler;
    }

    private async Task HandleLogout()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("BFF");
            await client.PostAsync("/api/auth/logout", null);
            NavigationManager.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Logout error: {ex.Message}");
            NavigationManager.NavigateTo("/login");
        }
    }

    private void OnThemeChangedHandler() => InvokeAsync(StateHasChanged);

    public void Dispose() => ThemeService.OnThemeChanged -= OnThemeChangedHandler;

    private string GetOptimizedUrl(string originalUrl)
    {
        if (string.IsNullOrEmpty(originalUrl)) return "/images/user-avatar.jpg";
        return originalUrl.Replace("/upload/", "/upload/w_40,h_30,c_fill,q_auto,f_auto/");
    }
}