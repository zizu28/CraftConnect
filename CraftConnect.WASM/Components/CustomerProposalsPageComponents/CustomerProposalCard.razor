@using CraftConnect.WASM.ViewModels
@inject IHttpClientFactory HttpClientFactory
@inject ILogger<CustomerProposalCard> Logger
@inject NavigationManager NavManager

<div class="customer-proposal-card">
    <div class="card-header">
        <img class="craftsman-avatar"
             src="@(string.IsNullOrEmpty(Proposal.CraftsmanAvatarUrl) ? "/images/user-avatar.png" : Proposal.CraftsmanAvatarUrl)"
             alt="@Proposal.CraftsmanName" />

        <div class="craftsman-details">
            <span class="name">@Proposal.CraftsmanName</span>
            <div class="rating">
                <i class="bi bi-star-fill text-warning"></i>
                <span>@Proposal.Rating.ToString("F1")</span>
                <span class="reviews">(@Proposal.ReviewCount)</span>
            </div>
        </div>
        <div class="price">@Proposal.Price.ToString("C0")</div>
    </div>

    <p class="quote-summary">@Proposal.QuoteSummary</p>

    <div class="card-actions">
        <!-- View Portfolio Link -->
        <a href="/craftsman/@Proposal.CraftsmanId" class="btn btn-view-portfolio">View Portfolio</a>

        <button class="btn btn-reject" @onclick="RejectProposal" disabled="@isProcessing">Reject</button>
        <button class="btn btn-accept" @onclick="AcceptProposal" disabled="@isProcessing">Accept</button>

        <button class="btn btn-more-info">More Info</button>
    </div>
</div>

@code {
    [Parameter] 
    public CustomerProposalVM Proposal { get; set; } = new();

    [Parameter] 
    public Guid ProjectId { get; set; }

    private bool isProcessing = false;

    private async Task AcceptProposal()
    {
        if (isProcessing) return;
        isProcessing = true;

        try
        {
            var client = HttpClientFactory.CreateClient("BFF");
            var response = await client.PostAsync($"/customerprojects/{ProjectId}/proposals/{Proposal.Id}/accept", null);

            if (response.IsSuccessStatusCode)
            {
                Logger.LogInformation($"Proposal {Proposal.Id} accepted.");
                NavManager.NavigateTo(NavManager.Uri, forceLoad: true);
            }
            else
            {
                Logger.LogError("Failed to accept proposal.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Error: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task RejectProposal()
    {
        if (isProcessing) return;
        isProcessing = true;

        try
        {
            var client = HttpClientFactory.CreateClient("BFF");
            var response = await client.PostAsync($"/customerprojects/{ProjectId}/proposals/{Proposal.Id}/reject", null);

            if (response.IsSuccessStatusCode)
            {
                Logger.LogInformation($"Proposal {Proposal.Id} rejected.");
                NavManager.NavigateTo(NavManager.Uri, forceLoad: true);
            }
            else
            {
                Logger.LogError("Failed to reject proposal.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Error: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
        }
    }
}