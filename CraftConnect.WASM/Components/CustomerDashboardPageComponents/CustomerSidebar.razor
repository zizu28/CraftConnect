@using Core.SharedKernel.DTOs
@using CraftConnect.WASM.ViewModels
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager NavManager
@inject IHttpClientFactory HttpClientFactory
@inject ILoggerFactory LoggerFactory

<nav class="sidebar">
    <div class="sidebar-top">
        <div class="logo-header">
            <!-- You can replace this with your actual logo SVG or <img> -->
            <i class="bi bi-tools logo-icon"></i>
            <span class="logo-text">CraftConnect</span>
        </div>

        <!-- User Profile Section -->
        <div class="user-profile">
            <div class="user-avatar">
                @if (!string.IsNullOrEmpty(User.AvatarUrl))
                {
                    <img src="@GetOptimizedImage(User.AvatarUrl)" alt="User avatar" />
                }
                else
                {
                    <span>@User.AvatarInitials</span>
                }                
            </div>
            <div class="user-info">
                <span class="welcome-text">Welcome back,</span>
                <span class="user-name">@User.Name</span>
            </div>
        </div>

        <!-- Navigation Links -->
        <div class="nav-links">
            <NavLink href=@($"/customer/{CustomerId}/dashboard") Match="NavLinkMatch.All" class="nav-item">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </NavLink>
            <NavLink href=@($"/customer/{CustomerId}/profile/edit") Match="NavLinkMatch.All" class="nav-item">
                <i class="bi bi-person-gear"></i>
                <span>Profile Setup</span>
            </NavLink>
            <NavLink href=@($"/customer/{CustomerId}/service-requests") Match="NavLinkMatch.Prefix" class="nav-item">
                <i class="bi bi-clipboard-data-fill"></i>
                <span>Service Requests</span>
            </NavLink>
            <NavLink href=@($"/customer/{CustomerId}/proposals") Match="NavLinkMatch.Prefix" class="nav-item">
                <i class="bi bi-file-earmark-text-fill"></i>
                <span>Proposals</span>
            </NavLink>
            <NavLink href=@($"/customer/{CustomerId}/project-history") Match="NavLinkMatch.Prefix" class="nav-item">
                <i class="bi bi-clock-history"></i>
                <span>Project History</span>
            </NavLink>
            <NavLink href=@($"/customer/{CustomerId}/messages") Match="NavLinkMatch.Prefix" class="nav-item">
                <i class="bi bi-chat-dots-fill"></i>
                <span>Messages</span>
                <span class="message-dot"></span>
            </NavLink>
        </div>
    </div>

    <!-- Post Project Button -->
    <button class="post-project-btn" @onclick="PostNewProject">
        Post a New Project
    </button>
</nav>

@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthenticationState { get; set; }

    private ILogger logger => LoggerFactory.CreateLogger<CustomerSidebar>();

    [Parameter]
    public Guid CustomerId { get; set; }
    [Parameter]
    public UserProfileVM User { get; set; } = new UserProfileVM { Name = "Jane Doe" }; // Default for design

    protected override async Task OnInitializedAsync()
    {
        var client = HttpClientFactory.CreateClient("BFF");
        try
        {
            var currentUser = await client.GetFromJsonAsync<CustomerResponseDTO>($"/users/customer/{CustomerId}");
            User = new UserProfileVM
            {
                AvatarInitials = $"{currentUser!.FirstName.Substring(0, 1).ToUpper()}.{currentUser!.LastName.Substring(0, 1).ToUpper()}",
                AvatarUrl = GetOptimizedImage(currentUser.ProfileImageUrl),
            };
        }
        catch(Exception ex)
        {
            
        }
    }

    private void PostNewProject()
    {
        NavManager.NavigateTo($"/customer/{CustomerId}/post-project");
    }

    private string GetOptimizedImage(string? url)
    {
        if (string.IsNullOrEmpty(url)) return "/images/user-avatar.jpg"; // Fix relative path
                                                                         // Cloudinary standard
        return url.Replace("/upload/", "/upload/w_40,h_30,c_fill,q_auto,f_auto/");
    }
}
