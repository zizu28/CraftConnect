@page "/admin/users"
@using Core.SharedKernel.Enums
@using CraftConnect.WASM.Layout.AdminPageLayouts
@using CraftConnect.WASM.Components.AdminPagesComponents.UserManagementPageComponent
@using CraftConnect.WASM.ViewModels
@layout AdminLayout

<div class="user-management-container">
    <!-- Page Header -->
    <header class="page-header">
        <h1>User Management</h1>
        <button class="btn btn-primary">
            <i class="bi bi-plus-lg"></i>
            Add New User
        </button>
    </header>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="search-container">
            <i class="search-icon bi bi-search"></i>
            <input type="text" class="search-input" placeholder="Search by name, email, or ID..." @bind="searchTerm" />
        </div>
        <div class="dropdown-filters">
            <select class="filter-dropdown" @bind="currentFilterRole">
                <option value="">Role: All</option>
                <option value="@UserType.Craftperson">Craftsman</option>
                <option value="@UserType.Customer">Customer</option>
                <option value="@UserType.Admin">Admin</option>
            </select>
            <select class="filter-dropdown" @bind="currentFilterStatus">
                <option value="">Status: All</option>
                <option value="@UserStatus.Active">Active</option>
                <option value="@UserStatus.Suspended">Suspended</option>
                <option value="@UserStatus.Deactivated">Deactivated</option>
            </select>
        </div>
    </div>

    <!-- User Table -->
    <div class="table-container">
        <table class="user-table">
            <thead>
                <tr>
                    <th><input type="checkbox" /></th>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Date Joined</th>
                    <th>Last Active</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in FilteredUsers.Skip((currentPage - 1) * pageSize).Take(pageSize))
                {
                    <tr>
                        <td><input type="checkbox" /></td>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar" style="background-color: @GetAvatarColor(user.AvatarInitial)">@user.AvatarInitial</div>
                                <div class="user-name-email">
                                    <span class="user-name">@user.Name</span>
                                    <span class="user-email">@user.Email</span>
                                </div>
                            </div>
                        </td>
                        <td><RoleBadge Role="user.Role" /></td>
                        <td><AdminStatusBadge Status="user.Status" /></td>
                        <td>@user.DateJoined.ToString("yyyy-MM-dd")</td>
                        <td>@user.LastActive.ToString("yyyy-MM-dd")</td>
                        <td>
                            <button class="actions-btn">
                                <i class="bi bi-three-dots"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        
        <!-- Table Footer & Pagination -->
        <div class="table-footer">
            <span>Showing 1 to @pageSize of @FilteredUsers.Count users</span>
            <AdminPagination CurrentPage="currentPage" TotalPages="totalPages" OnPageChanged="OnPageSelected" />
        </div>
    </div>
</div>

@code {
    private List<AdminUser> allUsers = new();
    private string searchTerm = "";
    private string currentFilterRole = "";
    private string currentFilterStatus = "";

    private int currentPage = 1;
    private int pageSize = 5; // From the image
    private int totalPages => (int)Math.Ceiling(FilteredUsers.Count / (double)pageSize);

    protected override void OnInitialized()
    {
        // Mock data from the image
        allUsers = new List<AdminUser>
        {
            new AdminUser { Id = Guid.NewGuid(), Name = "John Doe", Email = "john.doe@example.com", AvatarInitial = "JD", Role = UserType.Craftperson, Status = UserStatus.Active, DateJoined = new DateTime(2023, 1, 15), LastActive = new DateTime(2023, 10, 26) },
            new AdminUser { Id = Guid.NewGuid(), Name = "Jane Smith", Email = "jane.smith@example.com", AvatarInitial = "JS", Role = UserType.Customer, Status = UserStatus.Active, DateJoined = new DateTime(2023, 2, 20), LastActive = new DateTime(2023, 10, 25) },
            new AdminUser { Id = Guid.NewGuid(), Name = "Peter Jones", Email = "mary.williams@example.com", AvatarInitial = "PJ", Role = UserType.Craftperson, Status = UserStatus.Suspended, DateJoined = new DateTime(2023, 3, 10), LastActive = new DateTime(2023, 9, 15) },
            new AdminUser { Id = Guid.NewGuid(), Name = "Mary Williams", Email = "peter.jones@example.com", AvatarInitial = "MW", Role = UserType.Customer, Status = UserStatus.Deactivated, DateJoined = new DateTime(2023, 4, 5), LastActive = new DateTime(2023, 8, 1) },
            new AdminUser { Id = Guid.NewGuid(), Name = "David Brown", Email = "david.brown@example.com", AvatarInitial = "DB", Role = UserType.Admin, Status = UserStatus.Active, DateJoined = new DateTime(2023, 1, 1), LastActive = new DateTime(2023, 10, 26) }
        };
        // Add more users to test pagination
        for(int i = 6; i <= 25; i++)
        {
            allUsers.Add(new AdminUser { Id = Guid.NewGuid(), Name = $"User {i}", Email = $"user{i}@example.com", AvatarInitial = $"U{i}", Role = UserType.Customer, Status = UserStatus.Active, DateJoined = DateTime.Now.AddDays(-i * 10), LastActive = DateTime.Now.AddDays(-i) });
        }
    }

    private List<AdminUser> FilteredUsers
    {
        get
        {
            var filtered = allUsers.AsEnumerable();

            if (!string.IsNullOrEmpty(searchTerm))
            {
                filtered = filtered.Where(u =>
                    u.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    u.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
            }

            if (!string.IsNullOrEmpty(currentFilterRole) && Enum.TryParse<UserType>(currentFilterRole, out var role))
            {
                filtered = filtered.Where(u => u.Role == role);
            }

            if (!string.IsNullOrEmpty(currentFilterStatus) && Enum.TryParse<UserStatus>(currentFilterStatus, out var status))
            {
                filtered = filtered.Where(u => u.Status == status);
            }

            return filtered.ToList();
        }
    }

    private void OnPageSelected(int page)
    {
        currentPage = page;
    }

    // Helper to get avatar colors
    private string GetAvatarColor(string initial)
    {
        // Simple hash to get a color
        var hash = initial.GetHashCode();
        var colors = new[] { "#FEE2E2", "#FFEDD5", "#FEF9C3", "#DCFCE7", "#DBEAFE", "#E0E7FF", "#E5E7EB", "#F3E8FF" }; // Pastel colors
        return colors[Math.Abs(hash) % colors.Length];
    }
}
