@page "/login"
@layout LoginLayout
@inject IHttpClientFactory HttpClientFactory
@inject ILogger<Login> Logger
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

@using System.Security.Claims
@using Blazored.FluentValidation
@using Core.SharedKernel.DTOs
@using CraftConnect.WASM.Auth
@using CraftConnect.WASM.Layout
@using CraftConnect.WASM.Validators
@using CraftConnect.WASM.ViewModels
@using Microsoft.AspNetCore.Components.Authorization

<div class="login-card">
    <header class="login-card-header">
        <h2>Welcome Back</h2>
        <p>Log in to your account to continue.</p>
    </header>

    <!-- Login Form -->
    <EditForm Model="model" OnValidSubmit="HandleValidSubmit" class="login-form">
        <FluentValidationValidator Validator="@Validator" />

        <!-- Email -->
        <div class="form-group">
            <label for="email">Email or Username</label>
            <InputText id="email" @bind-Value="model.Email" class="form-control" placeholder="you@example.com" />
            <ValidationMessage For="() => model.Email" />
        </div>

        <!-- Password -->
        <div class="form-group">
            <div class="label-row">
                <label for="password">Password</label>
                <a href="/forgot-password" class="link-forgot">Forgot Password?</a>
            </div>
            <div class="password-wrapper">
                <InputText id="password" @bind-Value="model.Password" type="@(showPassword ? "text" : "password")" class="form-control" placeholder="••••••••" />

                <button type="button" class="password-toggle-btn" @onclick="TogglePasswordVisibility" tabindex="-1">
                    <i class="bi @(showPassword ? "bi-eye" : "bi-eye-slash")"></i>
                </button>
            </div>
            <ValidationMessage For="() => model.Password" />
        </div>

        <!-- Remember Me -->
        <div class="form-group-checkbox">
            <InputCheckbox id="remember" @bind-Value="model.RememberMe" />
            <label for="remember">Remember Me</label>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn-submit" disabled="@IsLoading">
            @if (IsLoading)
            {
                <span class="spinner"></span>
                <span>Logging in...</span>
            }
            else
            {
                <span>Log in</span>
                <i class="bi bi-arrow-right"></i>
            }
        </button>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger mt-2" style="font-size: 0.9rem; padding: 10px;">
                @ErrorMessage
            </div>
        }
    </EditForm>

    <!-- Separator -->
    <div class="separator">Or continue with</div>

    <!-- Social Logins -->
    <div class="social-login-group">
        <button type="button" class="btn-social">
            <img src="https://www.vectorlogo.zone/logos/github/github-icon.svg" alt="GitHub" />
            <span>GitHub</span>
        </button>
        <button type="button" class="btn-social">
            <img src="https://www.vectorlogo.zone/logos/google/google-icon.svg" alt="Google" />
            <span>Google</span>
        </button>
    </div>

    <!-- Sign Up Link -->
    <div class="signup-link">
        Don't have an account? <a href="/signup">Sign Up</a>
    </div>
</div>

@code {
    public LoginVMValidator Validator { get; set; } = new();
    private LoginUserCommand model = new();
    private bool showPassword = false;
    private bool IsLoading = false;
    private string? ErrorMessage;

    private void TogglePasswordVisibility() => showPassword = !showPassword;

    private async Task HandleValidSubmit()
    {
        if (IsLoading) return;
        IsLoading = true;
        ErrorMessage = null;

        try
        {
            var httpClient = HttpClientFactory.CreateClient("BFF");

            HttpResponseMessage response = await httpClient.PostAsJsonAsync("/api/auth/login", model);

            if (response.IsSuccessStatusCode)
            {
                var userInfo = await response.Content.ReadFromJsonAsync<UserResponseDTO>();

                if (userInfo != null)
                {
                    var authProvider = (BffAuthenticationStateProvider)AuthStateProvider;
                    authProvider.NotifyUserLoggedIn(userInfo);

                    Logger.LogInformation($"User {model.Email} logged in.");

                    NavigateUser(userInfo);
                }
            }
            else
            {
                ErrorMessage = "Invalid email or password.";
                Logger.LogWarning($"Login failed: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "An unexpected error occurred. Please try again.";
            Logger.LogError(ex, "Login exception");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void NavigateUser(UserResponseDTO user)
    {
        switch (user.Role)
        {
            case "Customer":
                NavigationManager.NavigateTo($"/customer/{user.UserId}/dashboard");
                break;
            case "Craftman":
                NavigationManager.NavigateTo($"/dashboard/{user.UserId}");
                break;
            case "Admin":
                NavigationManager.NavigateTo("/admin/dashboard");
                break;
            default:
                NavigationManager.NavigateTo("/");
                break;
        }
    }
}