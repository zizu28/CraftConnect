@page "/customer/{CustomerId:guid}/service-requests"
@using Core.SharedKernel.DTOs
@using Core.SharedKernel.Enums
@using CraftConnect.WASM.Components.CustomerDashboardPageComponents
@using CraftConnect.WASM.ViewModels
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@layout CustomerLayout
@inject NavigationManager NavManager
@inject IHttpClientFactory HttpClientFactory
@inject ILoggerFactory LoggerFactory

<div class="service-request-page">
    
    <!-- Tab Navigation -->
    <nav class="tab-nav">
        <a href=@($"/customer/{CustomerId}/service-requests") class="tab-item active">Service Requests (@serviceRequests.Count)</a>
        <a href=@($"/customer/{CustomerId}/proposals") class="tab-item">Proposals (5)</a>
        <a href="/customer/project-history" class="tab-item">Project History (1)</a>
    </nav>

    <!-- Page Content -->
    <div class="page-body">
        <h1 class="page-title">Service Requests</h1>

        <!-- Reusable Table Component -->
        <ServiceRequestsTable Requests="serviceRequests" CustomerId="@CustomerId" />
    </div>

</div>

@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthenticationState { get; set; }

    private ILogger<CustomerServiceRequests> Logger => LoggerFactory.CreateLogger<CustomerServiceRequests>();

    [Parameter]
    public Guid CustomerId { get; set; }
    private List<ServiceRequestVM> serviceRequests = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationState;
        var user = authState.User;
        if (user.Identity!.IsAuthenticated)
        {
            var userIdString = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (Guid.TryParse(userIdString, out var id))
            {
                CustomerId = id;
            }
        }
        try
        {
            var httpClient = HttpClientFactory.CreateClient("BFF");
            var response = await httpClient.GetAsync($"/customerprojects/my-projects");
            if (response.IsSuccessStatusCode)
            {
                var projectDtos = await response.Content.ReadFromJsonAsync<List<CustomerProjectResponseDTO>>();
                if (projectDtos != null)
                {
                    serviceRequests = projectDtos.Select(dto => new ServiceRequestVM
                    {
                        Id = dto.Id,
                        ProjectTitle = dto.Title,
                        Budget = dto.Budget.Amount,
                        Description = dto.Description,
                        Status = dto.Status
                    }).ToList();
                }
            }
            else
            {
                Logger.LogError("Failed to fetch service requests for customer {CustomerId}. Status Code: {StatusCode}", CustomerId, response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "An error occurred while fetching service requests for customer {CustomerId}", CustomerId);
        }
    }

    // protected override async Task OnInitializedAsync()
    // {
    //     // Mock data from the image
    //     serviceRequests = new List<ServiceRequestVM>
    //     {
    //         new ServiceRequestVM
    //         {
    //             Id = Guid.NewGuid(),
    //             ProjectTitle = "Custom Bookshelf",
    //             Category = "Carpentry",
    //             DateSubmitted = new DateTime(2023, 10, 26),
    //             Status = ServiceRequestStatus.InProgress
    //         },
    //         new ServiceRequestVM
    //         {
    //             Id = Guid.NewGuid(),
    //             ProjectTitle = "Kitchen Sink Repair",
    //             Category = "Plumbing",
    //             DateSubmitted = new DateTime(2023, 10, 24),
    //             Status = ServiceRequestStatus.AwaitingProposals
    //         },
    //         new ServiceRequestVM
    //         {
    //             Id = Guid.NewGuid(),
    //             ProjectTitle = "Apartment Painting",
    //             Category = "Painting",
    //             DateSubmitted = new DateTime(2023, 10, 20),
    //             Status = ServiceRequestStatus.AwaitingProposals
    //         }
    //     };
    // }
}

