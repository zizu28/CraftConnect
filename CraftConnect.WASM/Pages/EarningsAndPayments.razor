@page "/craftsman/{CraftsmanId:guid}/earnings"
@layout EarningsLayout
@using Core.SharedKernel.Enums
@using CraftConnect.WASM.Components.EarningsAndPaymentsPageComponents
@using CraftConnect.WASM.ViewModels

<div class="earnings-page">
    <header class="page-header">
        <h1>Earnings & Payments</h1>
        <button class="btn btn-export">
            <i class="bi bi-download"></i> Export Statement
        </button>
    </header>

    <!-- Stat Cards -->
    <div class="stat-grid">
        <EarningStatCard Title="Total Earnings to Date" Value="@stats.TotalEarningsToDate.ToString("C0")" IconClass="bi-wallet2" />
        <EarningStatCard Title="Earnings This Month" Value="@stats.EarningsThisMonth.ToString("C0")" IconClass="bi-graph-up-arrow" />
        <EarningStatCard Title="Pending Payouts" Value="@stats.PendingPayouts.ToString("C0")" IsPending="true" IconClass="bi-hourglass-split" />
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="search-container">
            <i class="bi bi-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Search transactions..."
                   @bind="searchTerm" @bind:event="oninput" />
        </div>

        <div class="filter-group">
            <select class="form-select" @bind="dateFilter">
                <option value="">Filter by Date</option>
                <option value="last-30">Last 30 days</option>
                <option value="this-month">This Month</option>
                <option value="last-month">Last Month</option>
            </select>

            <select class="form-select" @bind="projectFilter">
                <option value="">Filter by Project</option>
                <option value="project-1">Kitchen Renovation</option>
                <option value="project-2">Living Room Painting</option>
            </select>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="table-card">
        <TransactionTable Transactions="PaginatedTransactions" />

        <!-- Pagination Footer -->
        <div class="pagination-footer">
            <span class="pagination-info">
                Showing <strong>@StartItem</strong> to <strong>@EndItem</strong> of <strong>@TotalItemCount</strong> results
            </span>
            @if (TotalPages > 1)
            {
                <EarningsPagination CurrentPage="currentPage" TotalPages="TotalPages" OnPageChanged="HandlePageChange" />
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public Guid CraftsmanId { get; set; }
    private CraftsmanEarningStats stats = new();
    private List<CraftsmanTransaction> allTransactions = new();

    private string searchTerm = "";
    private string dateFilter = "";
    private string projectFilter = "";
    private int currentPage = 1;
    private int pageSize = 5;

    private List<CraftsmanTransaction> FilteredTransactions
    {
        get
        {
            var items = allTransactions.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                items = items.Where(i => 
                    i.Project.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) || 
                    i.Client.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
            }
            // Add date and project filter logic here
            if (!string.IsNullOrWhiteSpace(dateFilter))
            {
                var now = DateTime.UtcNow;
                items = dateFilter.ToLower() switch
                {
                    "last-30" => items.Where(i => (now - i.Date).TotalDays <= 30),
                    "this-month" => items.Where(i => (now - i.Date).TotalDays <= 30),
                    "last-month" => items.Where(i => (now - i.Date).TotalDays <= 60),
                    _ => items
                };
            }

            if (!string.IsNullOrWhiteSpace(projectFilter))
            {
                items = projectFilter.ToLower() switch
                {
                    "project-1" => items.Where(i => i.Project.Contains("Kitchen Renovation", StringComparison.OrdinalIgnoreCase)),
                    "project-2" => items.Where(i => i.Project.Contains("Living Room Painting", StringComparison.OrdinalIgnoreCase)),
                    _ => items
                };
            }

            return items.ToList();
        }
    }

    private int TotalItemCount => FilteredTransactions.Count;
    private int TotalPages => (int)Math.Ceiling(TotalItemCount / (double)pageSize);
    private int StartItem => TotalItemCount == 0 ? 0 : (currentPage - 1) * pageSize + 1;
    private int EndItem => Math.Min(currentPage * pageSize, TotalItemCount);
    
    private List<CraftsmanTransaction> PaginatedTransactions => FilteredTransactions
        .Skip((currentPage - 1) * pageSize)
        .Take(pageSize)
        .ToList();

    protected override void OnInitialized()
    {
        // Mock data from image
        stats = new CraftsmanEarningStats
        {
            TotalEarningsToDate = 12450.00m,
            EarningsThisMonth = 1200.00m,
            PendingPayouts = 500.00m
        };

        allTransactions = new List<CraftsmanTransaction>
        {
            new CraftsmanTransaction { Id = Guid.NewGuid(), Date = new DateTime(2025, 10, 26), Project = "Kitchen Renovation", Client = "John Doe", Amount = 2500.00m, PaymentMethod = "Credit Card", Status = TransactionStatus.Paid },
            new CraftsmanTransaction { Id = Guid.NewGuid(), Date = new DateTime(2025, 10, 22), Project = "Living Room Painting", Client = "Jane Smith", Amount = 800.00m, PaymentMethod = "Bank Transfer", Status = TransactionStatus.Paid },
            new CraftsmanTransaction { Id = Guid.NewGuid(), Date = new DateTime(2025, 10, 18), Project = "Custom Bookshelf", Client = "Peter Jones", Amount = 1200.00m, PaymentMethod = "Credit Card", Status = TransactionStatus.Paid },
            new CraftsmanTransaction { Id = Guid.NewGuid(), Date = new DateTime(2025, 10, 15), Project = "Bathroom Tiling", Client = "Mary Williams", Amount = 1500.00m, PaymentMethod = "Bank Transfer", Status = TransactionStatus.Pending },
            new CraftsmanTransaction { Id = Guid.NewGuid(), Date = new DateTime(2025, 10, 10), Project = "Garden Landscaping", Client = "David Brown", Amount = 3000.00m, PaymentMethod = "Credit Card", Status = TransactionStatus.Paid }
            // Add more items to test pagination
        };
    }

    private void HandlePageChange(int newPage)
    {
        currentPage = newPage;
    }
}