@page "/verify-email/{Email}"
@layout VerificationLayout
@using CraftConnect.WASM.ViewModels
@inject ILoggerFactory loggerFactory
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager

<div class="verification-card">

    <div class="card-icon">
        <i class="bi bi-envelope-check-fill icon-large"></i>
    </div>

    <div class="card-header">
        <h2>Check Your Inbox!</h2>
        <p>We've sent a confirmation link to your email address. Please click the link in the email to verify your account.</p>
    </div>

    <div class="card-footer">
        <span>Didn't receive an email?</span>
        <button type="button" class="btn-resend" @onclick="ResendEmail" disabled="@_isLoading">
            @if (_isLoading)
            {
                <span class="spinner-border spinner-border-sm me-1"></span>
                <span>Resending...</span>
            }
            else
            {
                <span>Resend</span>
            }
        </button>
    </div>

    <div class="back-to-login">
        <a href="/login" class="link-back">
            <i class="bi bi-arrow-left"></i>
            Back to Log In
        </a>
    </div>
</div>

@code {
    [Parameter]
    public string Email { get; set; } = string.Empty;
    private ILogger logger = default!;
    private bool _isLoading = false;

    protected override Task OnInitializedAsync()
    {
        logger = loggerFactory.CreateLogger<AccountVerification>();
        return base.OnInitializedAsync();
    }

    private async Task ResendEmail()
    {
        if (_isLoading) return;
        _isLoading = true;

        try
        {
            // FIX: Use the BFF Client, not direct connection
            var httpClient = HttpClientFactory.CreateClient("BFF");
            var command = new ResendEmailCommand { Email = this.Email };

            // Note: Ocelot route for User actions is usually /users/...
            var response = await httpClient.PostAsJsonAsync("/users/resend-email", command);

            if (response.IsSuccessStatusCode)
            {
                logger.LogInformation("Email resend to {email} successful.", Email);
                // Optional: Show success toast
            }
            else
            {
                logger.LogWarning("Failed to resend email.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Exception while resending email");
        }
        finally
        {
            _isLoading = false;
        }
    }
}