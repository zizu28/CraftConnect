@page "/dashboard/{CraftmanId:guid}"
@using Core.SharedKernel.DTOs
@using CraftConnect.WASM.Components
@using CraftConnect.WASM.Components.CraftsmanDashboardPageComponents
@using CraftConnect.WASM.Components.CustomerDashboardPageComponents
@using CraftConnect.WASM.Components.SharedComponents
@using CraftConnect.WASM.Components.SkeletonComponents
@using CraftConnect.WASM.ViewModels
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager NavManager
@inject IHttpClientFactory HttpClientFactory
@inject ILoggerFactory LoggerFactory

@if (DashboardData == null && Projects == null && ServiceRequests == null)
{
    <DashboardSkeleton />
}
else
{
    <CraftsmanDashboardNavbar />

    <div class="dashboard-page-container">
        <h2>Welcome, @CurrentCraftsman!</h2>

        @* --- 1. Metrics Cards --- *@
        <div class="metrics-grid">
            <MetricCard Title="Active Projects" Value="@DashboardData!.ActiveProjects.ToString()" AccentColor="#007bff" />
            <MetricCard Title="New Service Requests" Value="@DashboardData.NewServiceRequests.ToString()" AccentColor="#ffc107" HasIndicator="true" />
            <MetricCard Title="Unread Messages" Value="@DashboardData.UnreadMessages.ToString()" AccentColor="#28a745" />
            <MetricCard Title="Monthly Earnings" Value="@DashboardData.MonthlyEarnings" AccentColor="#6f42c1" />
        </div>

        @* --- 2. Main Two-Column Layout --- *@
        <div class="main-content-grid">
            <div class="left-panel">
                <ProjectTable Projects="@Projects" />
                @if (IsLoading)
                {
                    <p>Loading service requests...</p>
                }
                else if (ServiceRequests == null || ServiceRequests.Count == 0)
                {
                    <p>No service requests available.</p>
                }
                else
                {
                    <ServiceRequests Requests="@ServiceRequests" />
                }
                
            </div>

            <div class="right-panel">
                <QuickLinks CraftmanId="@CraftmanId" />
                <EarningsChart TotalEarnings="@DashboardData.TotalEarningsLast3Months" />
            </div>
        </div>
    </div>
}


@code {
    [Parameter]
    public Guid CraftmanId { get; set; }
    private string CurrentCraftsman { get; set; } = string.Empty;
    private DashboardVM DashboardData { get; set; } = new();
    private bool IsLoading { get; set; } = false;
    private List<ProjectItemVM> Projects { get; set; } = new();
    private List<ServiceRequestVM> ServiceRequests { get; set; } = new();
    private ILogger Logger => LoggerFactory.CreateLogger<CraftsmanDashboard>();

    protected override async Task OnInitializedAsync()
    {
        if (IsLoading) return;
        IsLoading = true;
        try
        {
            var httpClient = HttpClientFactory.CreateClient("BFF");
            var response = await httpClient.GetAsync($"/users/craftsman/{CraftmanId}");
            var serviceRequestResponse = await httpClient.GetAsync($"/customerprojects");
            if (response.IsSuccessStatusCode)
            {
                var user = await response.Content.ReadFromJsonAsync<CraftmanResponseDTO>();
                CurrentCraftsman = $"{user!.FirstName} {user.LastName}";
                Logger.LogInformation("Successfully fetched craftsman details.");
            }
            if (serviceRequestResponse.IsSuccessStatusCode)
            {
                var responseData = await serviceRequestResponse.Content.ReadFromJsonAsync<List<CustomerProjectResponseDTO>>();
                if (responseData != null)
                {
                    ServiceRequests = MapToViewModel(responseData);
                }
                Logger.LogInformation("Successfully fetched service requests.");
            }
            else
            {
                Logger.LogError("Failed to fetch service requests.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "An error occurred while initializing the dashboard.");
        }
        finally
        {
            IsLoading = false;
        }
    
        // Mock Data Initialization
        DashboardData = GetMockMetrics();
        Projects = GetMockProjects();
        // ServiceRequests = GetMockRequests();
    }

    private List<ServiceRequestVM> MapToViewModel(List<CustomerProjectResponseDTO> dtos)
    {
        return dtos.Select(dto => new ServiceRequestVM
        {
            Id = dto.Id,
            Title = dto.Title,
            Description = dto.Description,
        })
        .OrderByDescending(r => r.StartDate)
        .ToList();
    }

    private DashboardVM GetMockMetrics() => new()
    {
        ActiveProjects = 5, NewServiceRequests = 3, UnreadMessages = 8,
        MonthlyEarnings = "$2,500", TotalEarningsLast3Months = 7200M
    };

    private List<ProjectItemVM> GetMockProjects() => new()
    {
        new() { Project = "Custom Bookshelf", Client = "John Doe", Status = "In Progress", DueDate = "2023-12-15" },
        new() { Project = "Kitchen Remodel", Client = "Jane Smith", Status = "Completed", DueDate = "2023-11-20" },
        new() { Project = "Handcrafted Dining Table", Client = "Peter Jones", Status = "Pending Approval", DueDate = "2024-01-10" }
    };

    private List<ServiceRequestVM> GetMockRequests() => new()
    {
        new() { Title = "Alex Johnson - Custom Cabinetry", Description = "Looking for a set of custom kitchen cabinets. My kitchen is an unusual shape..." },
        new() { Title = "Maria Garcia - Bookshelf Installation", Description = "I have a pre-built bookshelf that needs to be securely mounted to my living room wall." }
    };
}