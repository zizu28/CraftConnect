@page "/dashboard/{CraftmanId:guid}"
@using Core.SharedKernel.DTOs
@using Core.SharedKernel.Enums
@using CraftConnect.WASM.Components
@using CraftConnect.WASM.Components.CraftsmanDashboardPageComponents
@using CraftConnect.WASM.Components.CustomerDashboardPageComponents
@using CraftConnect.WASM.Components.SharedComponents
@using CraftConnect.WASM.Components.SkeletonComponents
@using CraftConnect.WASM.ViewModels
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager NavManager
@inject IHttpClientFactory HttpClientFactory
@inject ILoggerFactory LoggerFactory

@if (DashboardData == null && Projects == null && ServiceRequests == null)
{
    <DashboardSkeleton />
}
else
{
    <CraftsmanDashboardNavbar />

    <div class="dashboard-page-container">
        <h2>Welcome, @CurrentCraftsman!</h2>

        @* --- 1. Metrics Cards --- *@
        <div class="metrics-grid">
            <MetricCard Title="Active Projects" Value="@DashboardData!.ActiveProjects.ToString()" AccentColor="#007bff" />
            <MetricCard Title="New Service Requests" Value="@DashboardData.NewServiceRequests.ToString()" AccentColor="#ffc107" HasIndicator="true" />
            <MetricCard Title="Unread Messages" Value="@DashboardData.UnreadMessages.ToString()" AccentColor="#28a745" />
            <MetricCard Title="Monthly Earnings" Value="@DashboardData.MonthlyEarnings" AccentColor="#6f42c1" />
        </div>

        @* --- 2. Main Two-Column Layout --- *@
        <div class="main-content-grid">
            <div class="left-panel">
                <ProjectTable Projects="@Projects" />
                @if (IsLoading)
                {
                    <p>Loading service requests...</p>
                }
                else if (ServiceRequests == null || ServiceRequests.Count == 0)
                {
                    <p>No service requests available.</p>
                }
                else
                {
                    <ServiceRequests Requests="@ServiceRequests" />
                }
                
            </div>

            <div class="right-panel">
                <QuickLinks CraftmanId="@CraftmanId" />
                <EarningsChart TotalEarnings="@DashboardData.TotalEarningsLast3Months" />
            </div>
        </div>
    </div>
}


@code {
    [Parameter]
    public Guid CraftmanId { get; set; }
    private string CurrentCraftsman { get; set; } = string.Empty;
    private DashboardVM DashboardData { get; set; } = new();
    private bool IsLoading { get; set; } = false;
    private List<ProjectItemVM> Projects { get; set; } = new();
    private List<ServiceRequestVM> ServiceRequests { get; set; } = new();
    private ILogger Logger => LoggerFactory.CreateLogger<CraftsmanDashboard>();

    protected override async Task OnInitializedAsync()
    {
        if (IsLoading) return;
        IsLoading = true;
        try
        {
            var httpClient = HttpClientFactory.CreateClient("BFF");
            var response = httpClient.GetAsync($"/users/craftsman/{CraftmanId}");
            var serviceRequestResponse = httpClient.GetAsync($"/customerprojects");
            var projectsResponse = httpClient.GetAsync("/customerprojects/my-projects");
            await Task.WhenAll(response, serviceRequestResponse, projectsResponse);
            var responseTask = response.Result;
            var serviceTask = serviceRequestResponse.Result;
            var projectTask = projectsResponse.Result;
            if (responseTask.IsSuccessStatusCode)
            {
                var user = await responseTask.Content.ReadFromJsonAsync<CraftmanResponseDTO>();
                CurrentCraftsman = $"{user!.FirstName} {user.LastName}";
                Logger.LogInformation("Successfully fetched craftsman details.");
            }
            if (serviceTask.IsSuccessStatusCode)
            {
                var responseData = await serviceTask.Content.ReadFromJsonAsync<List<CustomerProjectResponseDTO>>();
                if (responseData != null)
                {
                    ServiceRequests = MapToViewModel(responseData);
                }
                Logger.LogInformation("Successfully fetched service requests.");
            }
            else
            {
                Logger.LogError("Failed to fetch service requests.");
            }
            if (projectTask.IsSuccessStatusCode)
            {
                var responseData = await projectTask.Content.ReadFromJsonAsync<List<CustomerProjectResponseDTO>>();
                if (responseData != null)
                {
                    Projects = MapToProjectViewModel(responseData);
                }
                Logger.LogInformation("Successfully fetched project requests.");
            }
            else
            {
                Logger.LogError("Failed to fetch project requests.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "An error occurred while initializing the dashboard.");
        }
        finally
        {
            IsLoading = false;
        }

        // Mock Data Initialization
        DashboardData = GetMockMetrics();
        // Projects = GetMockProjects();
        // ServiceRequests = GetMockRequests();
    }

    private List<ProjectItemVM> MapToProjectViewModel(List<CustomerProjectResponseDTO> dtos)
    {
        return dtos.Select(dto => new ProjectItemVM
        {
            ProjectId = dto.Id,
            Project = dto.Title,
            Client = CurrentCraftsman,
            Status = dto.Status.ToString(),
            DueDate = dto.EndDate.ToString("yyyy-MM-dd")
        })
        .ToList();
    }

    private List<ServiceRequestVM> MapToViewModel(List<CustomerProjectResponseDTO> dtos)
    {
        return dtos.Select(dto => new ServiceRequestVM
        {
            Id = dto.Id,
            Title = dto.Title,
            Description = dto.Description,
        })
        .OrderByDescending(r => r.StartDate)
        .ToList();
    }

    private DashboardVM GetMockMetrics() => new()
    {
        ActiveProjects = 5, NewServiceRequests = 3, UnreadMessages = 8,
        MonthlyEarnings = "$2,500", TotalEarningsLast3Months = 7200M
    };
}