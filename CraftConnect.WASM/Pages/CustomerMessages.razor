@page "/customer/messages"
@layout CustomerLayout
@using CraftConnect.WASM.Components.CustomerMessagesPageComponents
@using CraftConnect.WASM.ViewModels
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@inject ILoggerFactory LoggerFactory

<div class="messages-page-layout">
    <aside class="conversation-list-container @(selectedConversationId != null ? "mobile-hidden" : "")">
        <div class="search-bar-messages">
            <i class="bi bi-search search-icon"></i>
            <input type="text" placeholder="Search by craftsman or project" />
        </div>

        <div class="conversation-list">
            @if (viewModel.Conversations.Any())
            {
                @foreach (var conversation in viewModel.Conversations)
                {
                    <ConversationListItem Conversation="conversation"
                                          IsActive="conversation.Id == selectedConversationId"
                                          OnSelectConversation="() => SelectConversation(conversation.Id)" />
                }
            }
            else
            {
                <div class="empty-state">No messages yet.</div>
            }
        </div>
    </aside>

    @if (selectedConversationId != null)
    {
        <div class="active-chat-container @(selectedConversationId != null ? "mobile-visible" : "")">
            <ActiveChats ProjectTitle="@viewModel.ActiveProjectTitle"
                         ConversationWith="@viewModel.ActiveConversationWith"
                         Messages="@viewModel.ActiveChatMessages"
                         OnBack="() => selectedConversationId = null" />
        </div>
    }
    else
    {
        <div class="no-chat-selected">
            <i class="bi bi-chat-text-fill icon-large"></i>
            <h3>Select a conversation</h3>
            <p>Choose a conversation from the list to start chatting.</p>
        </div>
    }
</div>

@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    // Note: This page is usually accessed via /customer/messages, so CustomerId comes from State, not Route
    private Guid CustomerId { get; set; }

    private MessagesViewModel viewModel = new();
    private Guid? selectedConversationId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateTask;
        var user = authState.User;

        if (user.Identity == null || !user.Identity.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        var idClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (idClaim != null) CustomerId = Guid.Parse(idClaim);

        // Load Mock Data (Replace with API call later)
        LoadMockData();
    }

    private void SelectConversation(Guid id)
    {
        selectedConversationId = id;
        LoadActiveChat(id);
    }

    private void LoadActiveChat(Guid id)
    {
        var conversation = viewModel.Conversations.FirstOrDefault(c => c.Id == id);
        if (conversation == null) return;

        viewModel.ActiveProjectTitle = conversation.ProjectTitle;
        viewModel.ActiveConversationWith = conversation.OtherUserName;

        // Mock logic: In real app, fetch messages by Conversation ID
        viewModel.ActiveChatMessages = GetMockMessagesFor(id);
    }

    private void LoadMockData()
    {
        viewModel.CurrentUser = new UserProfileVM { Name = "John Smith" };
        viewModel.Conversations = new List<ConversationSummaryVM>
        {
            new() {
                Id = Guid.NewGuid(), ProjectTitle = "Kitchen Cabinet Installation", OtherUserName = "Jane Doe",
                OtherUserAvatarUrl = "https://placehold.co/40x40/EAB308/FFFFFF?text=JD",
                LatestMessagePreview = "Sounds good, I'll send over the...", LatestMessageTimestamp = "2:45 PM", IsRead = false
            },
            new() {
                Id = Guid.NewGuid(), ProjectTitle = "Custom Bookshelf Build", OtherUserName = "Bob The Builder",
                OtherUserAvatarUrl = "https://placehold.co/40x40/EF4444/FFFFFF?text=BB",
                LatestMessagePreview = "The materials have been ordered.", LatestMessageTimestamp = "Yesterday", IsRead = true
            }
        };
    }

    private List<ChatMessageDataVM> GetMockMessagesFor(Guid conversationId)
    {
        // Return dummy messages
        return new List<ChatMessageDataVM>
        {
            new() {
                Id = Guid.NewGuid(), SenderName = "Jane Doe", SenderAvatarUrl = "https://placehold.co/40x40/EAB308/FFFFFF?text=JD",
                IsSentByUser = false, Timestamp = "2:40 PM", MessageText = "Hi John, I can start next Monday."
            },
            new() {
                Id = Guid.NewGuid(), SenderName = "John Smith", SenderAvatarUrl = "https://placehold.co/40x40/FDBA74/7C2D12?text=JS",
                IsSentByUser = true, Timestamp = "2:42 PM", MessageText = "Perfect, see you then!"
            }
        };
    }
}