@page "/customer/messages"
@layout CraftsmanLayout
@using CraftConnect.WASM.Components.CustomerMessagesPageComponents
@using CraftConnect.WASM.ViewModels
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@inject ILoggerFactory LoggerFactory


<div class="messages-page-layout">
    <!-- Search and Conversation List -->
    <aside class="conversation-list-container @(selectedConversationId != null ? "mobile-hidden" : "")">
        <div class="search-bar-messages">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11zM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 1 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9z" clip-rule="evenodd" /></svg>
            <input type="text" placeholder="Search by craftsman or project" />
        </div>
        
        <div class="conversation-list">
            @foreach (var conversation in viewModel.Conversations)
            {
                <ConversationListItem 
                    Conversation="conversation"
                    IsActive="conversation.Id == selectedConversationId"
                    OnSelectConversation="() => SelectConversation(conversation.Id)"
                />
            }
        </div>
    </aside>

    <!-- Active Chat Window -->
    @if (selectedConversationId != null)
    {
        <div class="active-chat-container @(selectedConversationId != null ? "mobile-visible" : "")">
            <ActiveChats 
                ProjectTitle="@viewModel.ActiveProjectTitle"
                ConversationWith="@viewModel.ActiveConversationWith"
                Messages="viewModel.ActiveChatMessages"
                OnBack="() => selectedConversationId = null"
            />
        </div>
    }
    else
    {
        <div class="no-chat-selected">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.804 21.644A6.707 6.707 0 0 1 0 16.03V7.97a6.707 6.707 0 0 1 4.804-5.614l.196-.065a.684.684 0 0 1 .593 0l.196.065A6.707 6.707 0 0 1 10.4 7.97v8.06c0 2.418-1.27 4.59-3.2 5.614l-.196.065a.684.684 0 0 1-.593 0l-.196-.065ZM14.4 2.356a6.707 6.707 0 0 1 4.804 5.614v8.06c0 2.418-1.27 4.59-3.2 5.614l-.196.065a.684.684 0 0 1-.593 0l-.196-.065a6.707 6.707 0 0 1-3.2-5.614V7.97A6.707 6.707 0 0 1 14.4 2.356Z" clip-rule="evenodd" /></svg>
            <h3>Select a conversation</h3>
            <p>Choose a conversation from the list to start chatting.</p>
        </div>
    }

</div>

@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthStateTask { get; set; }
    [Parameter]
    public Guid CustomerId { get; set; }
    private MessagesViewModel viewModel = new();
    private Guid? selectedConversationId = Guid.NewGuid();

    protected override async Task OnInitializedAsync()
    {
        // Mock Data based on the image
        viewModel.CurrentUser = new UserProfileVM { Name = "John Smith" };

        viewModel.Conversations = new List<ConversationSummaryVM>
        {
            new ConversationSummaryVM
            {
                Id = Guid.NewGuid(), ProjectTitle = "Kitchen Cabinet Installation", OtherUserName = "Jane Doe",
                OtherUserAvatarUrl = "https://placehold.co/40x40/EAB308/FFFFFF?text=JD",
                LatestMessagePreview = "Sounds good, I'll send over the...",
                LatestMessageTimestamp = "2:45 PM", IsRead = false
            },
            new ConversationSummaryVM 
            {
                Id = Guid.NewGuid(), ProjectTitle = "Custom Bookshelf Build", OtherUserName = "Bob The Builder",
                OtherUserAvatarUrl = "https://placehold.co/40x40/EF4444/FFFFFF?text=BB",
                LatestMessagePreview = "The materials have been ordered.",
                LatestMessageTimestamp = "Yesterday", IsRead = true
            },
            new ConversationSummaryVM 
            {
                Id = Guid.NewGuid(), ProjectTitle = "Bathroom Remodeling", OtherUserName = "Sarah Conner",
                OtherUserAvatarUrl = "https://placehold.co/40x40/6B7280/FFFFFF?text=SC",
                LatestMessagePreview = "Perfect, thank you!",
                LatestMessageTimestamp = "Mon", IsRead = true
            }
        };

        // Load active chat for the default selected conversation
        var chat = viewModel.Conversations.FirstOrDefault(c => c.ProjectTitle.StartsWith("Kitchen Cabinet"));
        LoadActiveChat(chat!.Id);
    }

    private void SelectConversation(Guid id)
    {
        selectedConversationId = id;
        LoadActiveChat(id);
    }

    private void LoadActiveChat(Guid id)
    {
        // In a real app, you'd fetch this. Here we just set mock data.
        var conversation = viewModel.Conversations.FirstOrDefault(c => c.Id == id);
        if (conversation == null) return;

        viewModel.ActiveProjectTitle = conversation.ProjectTitle;
        viewModel.ActiveConversationWith = conversation.OtherUserName;
        
        // Mock messages for conversation 1
        viewModel.ActiveChatMessages = new List<ChatMessageDataVM>
        {
            new ChatMessageDataVM { 
                Id = Guid.NewGuid(), SenderName = "Jane Doe", SenderAvatarUrl = "https://placehold.co/40x40/EAB308/FFFFFF?text=JD",
                IsSentByUser = false, Timestamp = "2:40 PM",
                MessageText = "Hi John, I've reviewed the project details. I can start next Monday. Does that work for you?"
            },
            new ChatMessageDataVM { 
                Id = Guid.NewGuid(), SenderName = "John Smith", SenderAvatarUrl = "https://placehold.co/40x40/FDBA74/7C2D12?text=JS",
                IsSentByUser = true, Timestamp = "2:42 PM",
                MessageText = "Hi Jane, Monday works perfectly. What time should I expect you?"
            },
            new ChatMessageDataVM { 
                Id = Guid.NewGuid(), SenderName = "Jane Doe", SenderAvatarUrl = "https://placehold.co/40x40/EAB308/FFFFFF?text=JD",
                IsSentByUser = false, Timestamp = "2:44 PM",
                MessageText = "I'll be there around 9 AM. Also, I've attached the initial quote for you to review.",
                Attachment = new AttachedDocument { FileName = "Quote_Kitchen_Cabinets.pdf", DownloadUrl = "#" }
            },
            new ChatMessageDataVM { 
                Id = Guid.NewGuid(), SenderName = "John Smith", SenderAvatarUrl = "https://placehold.co/40x40/FDBA74/7C2D12?text=JS",
                IsSentByUser = true, Timestamp = "2:45 PM", IsSeen = true,
                MessageText = "Sounds good, I'll send over the deposit shortly."
            }
        };
    }
}
