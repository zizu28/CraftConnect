@page "/customer/payment-history"
@layout PaymentLayout
@using CraftConnect.WASM.Layout
@using CraftConnect.WASM.Components.PaymentHistoryPageComponents
@using CraftConnect.WASM.ViewModels

<div class="payment-history-page">
    <header class="history-header">
        <div class="header-text">
            <h1>Payment History</h1>
            <p>View and manage your past transactions.</p>
        </div>
        <button class="btn btn-export">
            <i class="bi bi-download"></i> Export History
        </button>
    </header>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="search-container">
            <i class="bi bi-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Search by project or craftsman..."
                   @bind="searchTerm" @bind:event="oninput" />
        </div>

        <div class="dropdown-group">
            <div class="filter-select-wrapper">
                <i class="bi bi-calendar3 filter-icon"></i>
                <select class="filter-select" @bind="dateFilter">
                    <option value="">Filter by Date</option>
                    <option value="last-30">Last 30 days</option>
                    <option value="last-90">Last 90 days</option>
                    <option value="2025">This Year</option>
                    <option value="2024">Last Year</option>
                </select>
            </div>

            <div class="filter-select-wrapper">
                <i class="bi bi-credit-card filter-icon"></i>
                <select class="filter-select" @bind="paymentMethodFilter">
                    <option value="">Filter by Method</option>
                    <option value="credit-card">Credit Card</option>
                    <option value="paypal">PayPal</option>
                    <option value="bank-transfer">Bank Transfer</option>
                    <option value="mobile-money">Mobile Money</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Table & Pagination -->
    <div class="table-card">
        <PaymentHistoryTable Items="FilteredItems" />

        <!-- Pagination Component -->
        <SimplePagination CurrentPage="currentPage" TotalItems="TotalItemCount" PageSize="pageSize" OnPageChanged="HandlePageChange" />
    </div>
</div>

@code {
    private string searchTerm = "";
    private string dateFilter = "";
    private string paymentMethodFilter = "";
    private int currentPage = 1;
    private int pageSize = 5;

    private List<PaymentHistoryItem> allItems = new();

    private List<PaymentHistoryItem> FilteredItems
    {
        get
        {
            var items = allItems.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                items = items.Where(i =>
                    i.Project.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    i.CraftsmanName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
            }

            // Add date and payment method filter logic here
            if (!string.IsNullOrWhiteSpace(dateFilter))
            {
                var now = DateTime.UtcNow;
                items = dateFilter.ToLower() switch
                {
                    "last-30" => items.Where(i => (now - i.Date).TotalDays <= 30),
                    "last-90" => items.Where(i => (now - i.Date).TotalDays <= 90),
                    "2025" => items.Where(i => i.Date.Year == 2025),
                    "2024" => items.Where(i => i.Date.Year == 2024),
                    _ => items
                };
            }

            if (!string.IsNullOrWhiteSpace(paymentMethodFilter))
            {
                items = paymentMethodFilter.ToLower() switch
                {
                    "credit-card" => items.Where(i => i.PaymentMethod.Contains("Credit", StringComparison.OrdinalIgnoreCase)),
                    "paypal" => items.Where(i => i.PaymentMethod.Contains("PayPal", StringComparison.OrdinalIgnoreCase)),
                    "bank-transfer" => items.Where(i => i.PaymentMethod.Contains("Bank", StringComparison.OrdinalIgnoreCase)),
                    "mobile-money" => items.Where(i => i.PaymentMethod.Contains("Mobile", StringComparison.OrdinalIgnoreCase)),
                    _ => items
                };
            }

            return items
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();
        }
    }

    private int TotalItemCount => allItems.Count; // This should be FilteredItems.Count *before* pagination

    protected override void OnInitialized()
    {
        // Mock data from image
        allItems = new List<PaymentHistoryItem>
        {
            new PaymentHistoryItem { Id = Guid.NewGuid(), Project = "Kitchen Renovation", CraftsmanName = "John Smith", Date = new DateTime(2025, 10, 26), Amount = 2500.00m, PaymentMethod = "Credit Card" },
            new PaymentHistoryItem { Id = Guid.NewGuid(), Project = "Custom Bookshelf", CraftsmanName = "Jane Doe", Date = new DateTime(2025, 10, 24), Amount = 800.00m, PaymentMethod = "PayPal" },
            new PaymentHistoryItem { Id = Guid.NewGuid(), Project = "Plumbing Repair", CraftsmanName = "Mike Johnson", Date = new DateTime(2025, 10, 22), Amount = 150.00m, PaymentMethod = "Credit Card" },
            new PaymentHistoryItem { Id = Guid.NewGuid(), Project = "Garden Landscaping", CraftsmanName = "Emily White", Date = new DateTime(2025, 10, 20), Amount = 1200.00m, PaymentMethod = "Bank Transfer" },
            new PaymentHistoryItem { Id = Guid.NewGuid(), Project = "Electrical Wiring", CraftsmanName = "David Green", Date = new DateTime(2025, 10, 18), Amount = 450.00m, PaymentMethod = "Credit Card" }
            // Add more items to test pagination
        };
    }

    private void HandlePageChange(int newPage)
    {
        currentPage = newPage;
    }
}