@page "/customer/{CustomerId:guid}/project/{ProjectId:guid}/proposals"
@layout CustomerLayout
@using Core.SharedKernel.DTOs
@using CraftConnect.WASM.Components.CustomerProposalsPageComponents
@using CraftConnect.WASM.ViewModels
@inject IHttpClientFactory HttpClientFactory
@inject ILogger<CustomerProposals> Logger

<div class="customer-proposals-page">
    @if (isLoading)
    {
        <p>Loading proposals...</p>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    else if (projectSummary != null)
    {
        <div class="header-with-filter">
            <h1 class="page-title">Proposals for: @projectSummary.ProjectTitle</h1>

            <div class="filter-info">
                <span class="badge bg-secondary">@projectSummary.ProposalCount Proposals</span>
            </div>
        </div>

        <CustomerProposalGroup ProjectSummary="projectSummary" ProjectId="@ProjectId" />
    }
    else
    {
        <p>No proposals found for this project.</p>
    }
</div>

@code {
    [Parameter] public Guid CustomerId { get; set; }
    [Parameter] public Guid ProjectId { get; set; }

    private CustomerProjectSummaryVM? projectSummary;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("BFF");

            var projectResponse = await client.GetAsync($"/customerprojects/{ProjectId}");
            var projectDto = await projectResponse.Content.ReadFromJsonAsync<CustomerProjectResponseDTO>();

            var proposalsResponse = await client.GetAsync($"/customerprojects/{ProjectId}/proposals");
            var proposalDtos = await proposalsResponse.Content.ReadFromJsonAsync<List<CraftsmanProposalResponseDTO>>();

            if (projectDto != null && proposalDtos != null)
            {
                projectSummary = new CustomerProjectSummaryVM
                {
                    Id = 0,
                    ProjectTitle = projectDto.Title,
                    ProposalCount = proposalDtos.Count,
                    Proposals = proposalDtos.Select(MapToVM).ToList()
                };
            }
            else
            {
                errorMessage = "Could not load project data.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Error loading proposals: {ex.Message}");
            errorMessage = "Failed to load proposals.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private CustomerProposalVM MapToVM(CraftsmanProposalResponseDTO dto)
    {
        return new CustomerProposalVM
        {
            Id = dto.Id,
            ServiceRequestId = dto.ProjectId,
            CraftsmanName = dto.CraftsmanName, // Populated by Backend Aggregate
            // CraftsmanAvatarUrl = ... (Need to fetch or include in DTO)
            Price = dto.Price.Amount,
            QuoteSummary = dto.CoverLetter,
            Rating = 5.0, // Placeholder
            ReviewCount = 0 // Placeholder
        };
    }
}