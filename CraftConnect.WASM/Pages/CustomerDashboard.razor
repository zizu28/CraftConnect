@page "/customer/{CustomerId:guid}/dashboard"
@layout CustomerLayout
@inject NavigationManager NavManager
@using Core.SharedKernel.DTOs
@using Core.SharedKernel.Enums
@using CraftConnect.WASM.Components.CustomerDashboardPageComponents
@using CraftConnect.WASM.Components.SkeletonComponents
@using CraftConnect.WASM.ViewModels
@using Microsoft.AspNetCore.Components.Authorization
@using System.Threading.Tasks
@using System.Security.Claims
@inject IHttpClientFactory HttpClientFactory
@inject ILoggerFactory LoggerFactory

@if (isLoading)
{
    <p>Loading...</p>
}
else
{
    <div class="dashboard-container">
        <h1>Dashboard</h1>
        
        <!-- Stat Cards -->
        <div class="stat-grid">
            <StatCard Title="Active Service Requests" Value="@dashboardData.ActiveServiceRequests.ToString()" />
            <StatCard Title="New Proposals" Value="@dashboardData.NewProposals.ToString()" />
            <StatCard Title="Unread Messages" Value="@dashboardData.UnreadMessages.ToString()" />
        </div>

        <div class="dashboard-grid">
            <!-- Left Column -->
            <div class="dashboard-col">
                @if(dashboardData.RecentServiceRequests.Count == 0)
                {
                    <p>No service requests available for you.</p>
                }
                else
                {
                    <section class="dashboard-section">
                        <div class="section-header">
                            <h2>Service Requests</h2>
                            <a href=@($"/customer/{CustomerId}/service-requests") class="view-all-link">View All</a>
                        </div>
                        <ServiceRequestsTable Requests="dashboardData.RecentServiceRequests" IsMini="true" CustomerId="@CustomerId" />
                    </section>
                }
                
                @if(dashboardData.IncomingProposals.Count == 0)
                {
                    <p>No proposals available for you.</p>
                }
                else
                {
                    <section class="dashboard-section">
                        <div class="section-header">
                            <h2>Incoming Proposals</h2>
                            <a href=@($"/customer/{CustomerId}/proposals") class="view-all-link">View All</a>
                        </div>
                        <div class="card-list">
                            @foreach (var proposal in dashboardData.IncomingProposals)
                            {
                                <ProposalCard Proposal="proposal" />
                            }
                        </div>
                    </section>
                }                
            </div>
            
            <!-- Right Column (Sidebar) -->
            <div class="dashboard-col">
                <section class="dashboard-section">
                    <div class="section-header">
                        <h2>Inbox Preview</h2>
                        <a href=@($"/customer/messages") class="view-all-link">View All</a>
                    </div>
                    <div class="inbox-list">
                        @foreach (var message in dashboardData.InboxPreview)
                        {
                            <InboxPreview Message="message" />
                        }
                    </div>
                </section>
            </div>
        </div>
    </div>
}

@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthenticationState { get; set; }

    private ILogger<CustomerDashboard> logger => LoggerFactory.CreateLogger<CustomerDashboard>();

    [Parameter]
    public Guid CustomerId { get; set; }

    private CustomerDashboardVM? dashboardData { get; set; }

    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        var authState = await AuthenticationState;
        var user = authState.User;
        if (user.Identity!.IsAuthenticated)
        {
            var userIdString = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (Guid.TryParse(userIdString, out var id))
            {
                CustomerId = id;
            }
        }
        else
        {
            NavManager.NavigateTo("/login");
            return;
        }
        try
        {
            var httpClient = HttpClientFactory.CreateClient("BFF");
            var proposalsTask = httpClient.GetFromJsonAsync<List<CraftsmanProposalResponseDTO>>($"/customerprojects/incoming-proposals");
            var projectsTask = httpClient.GetFromJsonAsync<List<CustomerProjectResponseDTO>>("/customerprojects/my-projects");

            await Task.WhenAll(proposalsTask, projectsTask);

            var proposals = proposalsTask.Result ?? new();
            var projects = projectsTask.Result ?? new();
            dashboardData = new CustomerDashboardVM
            {
                ActiveServiceRequests = projects.Count(p => p.Status == ServiceRequestStatus.Open || p.Status == ServiceRequestStatus.InProgress),
                NewProposals = proposals.Count(p => p.Status == ProposalStatus.Pending),
                UnreadMessages = 2,
                RecentServiceRequests = projects
                    .OrderByDescending(p => p.Timeline.Start)
                    .Take(3)
                    .Select(p => new ServiceRequestVM
                    {
                        Id = p.Id,
                        ProjectTitle = p.Title,
                        Category = p.Category.ToString(),
                        DateSubmitted = p.Timeline.Start,
                        Status = p.Status
                    }).ToList(),
                IncomingProposals = proposals
                    .OrderByDescending(p => p.SubmittedDate)
                    .Take(5)
                    .Select(p => new CustomerProposalSummaryVM
                    {
                        Id = p.Id,
                        CraftsmanName = p.CraftsmanName,
                        Price = p.Price.Amount,
                        CraftsmanAvatarUrl = GetOptimizedImage(p.CraftsmanAvatarUrl),
                        CraftsmanRating = 5.0, // 
                        Excerpt = p.CoverLetter.Length > 60 ? p.CoverLetter.Substring(0, 60) + "..." : p.CoverLetter                        
                    }).ToList(),
                InboxPreview = new List<InboxMessageVM>
            {
                new InboxMessageVM { Id = 1, SenderName = "Alex Johnson", Excerpt = "Sounds great! I'll send over the final designs by the end of the day.", ReceivedTime = "10:45 AM", IsRead = false, IsSupportTicket = false, SenderAvatarInitials = "AJ" },
                new InboxMessageVM { Id = 2, SenderName = "John Smith", Excerpt = "I've received the payment. Thank you!", ReceivedTime = "Yesterday", IsRead = true, IsSupportTicket = false, SenderAvatarInitials = "JS" },
                new InboxMessageVM { Id = 3, SenderName = "Support Team", Excerpt = "We've updated our terms of service. Please review them.", ReceivedTime = "2 days ago", IsRead = true, IsSupportTicket = true, SenderAvatarInitials = "ST" }
            }
            };
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error loading dashboard data for customer {CustomerId}", CustomerId);
        }
        finally
        {
            isLoading = false;
        }
        
    }

    private string GetOptimizedImage(string? url)
    {
        if (string.IsNullOrEmpty(url)) return "/images/user-avatar.jpg"; // Fix relative path
                                                                            // Cloudinary standard
        return url.Replace("/upload/", "/upload/w_100,h_100,c_fill,q_auto,f_auto/");
    }
}
