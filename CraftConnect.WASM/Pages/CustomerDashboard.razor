@page "/customer/{CustomerId:guid}/dashboard"
@layout CustomerLayout
@inject NavigationManager NavManager
@using CraftConnect.WASM.Components.CustomerDashboardPageComponents
@using CraftConnect.WASM.Components.SkeletonComponents
@using CraftConnect.WASM.Enums
@using CraftConnect.WASM.ViewModels
@using Microsoft.AspNetCore.Components.Authorization
@using System.Threading.Tasks
@using System.Security.Claims

@if (isLoading)
{
    <p>Loading...</p>
}
else
{
    <div class="dashboard-container">
        <h1>Dashboard</h1>
        
        <!-- Stat Cards -->
        <div class="stat-grid">
            <StatCard Title="Active Service Requests" Value="@dashboardData.ActiveServiceRequests.ToString()" />
            <StatCard Title="New Proposals" Value="@dashboardData.NewProposals.ToString()" />
            <StatCard Title="Unread Messages" Value="@dashboardData.UnreadMessages.ToString()" />
        </div>

        <div class="dashboard-grid">
            <!-- Left Column -->
            <div class="dashboard-col">
                <section class="dashboard-section">
                    <div class="section-header">
                        <h2>Service Requests</h2>
                        <a href=@($"/customer/{CustomerId}/service-requests") class="view-all-link">View All</a>
                    </div>
                    <ServiceRequestsTable Requests="dashboardData.RecentServiceRequests" IsMini="true" CustomerId="@CustomerId" />
                </section>

                <section class="dashboard-section">
                    <div class="section-header">
                        <h2>Incoming Proposals</h2>
                        <a href=@($"/customer/{CustomerId}/proposals") class="view-all-link">View All</a>
                    </div>
                    <div class="card-list">
                        @foreach (var proposal in dashboardData.IncomingProposals)
                        {
                            <ProposalCard Proposal="proposal" />
                        }
                    </div>
                </section>
            </div>
            
            <!-- Right Column (Sidebar) -->
            <div class="dashboard-col">
                <section class="dashboard-section">
                    <div class="section-header">
                        <h2>Inbox Preview</h2>
                        <a href=@($"/customer/{CustomerId}/messages") class="view-all-link">View All</a>
                    </div>
                    <div class="inbox-list">
                        @foreach (var message in dashboardData.InboxPreview)
                        {
                            <InboxPreview Message="message" />
                        }
                    </div>
                </section>
            </div>
        </div>
    </div>
}

@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthenticationState { get; set; }

    [Parameter]
    public Guid CustomerId { get; set; }

    private CustomerDashboardVM? dashboardData;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationState;
        var user = authState.User;
        if (user.Identity!.IsAuthenticated)
        {
            var userIdString = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (Guid.TryParse(userIdString, out var id))
            {
                CustomerId = id;
            }
        }
        else
        {
            NavManager.NavigateTo("/login");
            return;
        }

        // Mock data for the dashboard
        dashboardData = new CustomerDashboardVM
        {
            ActiveServiceRequests = 3,
            NewProposals = 5,
            UnreadMessages = 2,
            RecentServiceRequests = new List<ServiceRequestVM>
            {
                new ServiceRequestVM { Id = Guid.NewGuid(), ProjectTitle = "Custom Bookshelf", Category = "Carpentry", DateSubmitted = new DateTime(2023, 10, 26), Status = ServiceRequestStatus.InProgress },
                new ServiceRequestVM { Id = Guid.NewGuid(), ProjectTitle = "Kitchen Sink Repair", Category = "Plumbing", DateSubmitted = new DateTime(2023, 10, 24), Status = ServiceRequestStatus.AwaitingProposals },
                new ServiceRequestVM { Id = Guid.NewGuid(), ProjectTitle = "Garden Landscaping", Category = "Gardening", DateSubmitted = new DateTime(2023, 09, 15), Status = ServiceRequestStatus.Completed }
            },
            IncomingProposals = new List<CustomerProposalSummaryVM>
            {
                new CustomerProposalSummaryVM { Id = Guid.NewGuid(), CraftsmanName = "John Smith", CraftsmanRating = 4.8, Price = 450, Excerpt = "\"I can build your custom bookshelf with high-quality oak and have it done within a week.\"", ProposalUrl = "#", ProfileUrl = "#" },
                new CustomerProposalSummaryVM { Id = Guid.NewGuid(), CraftsmanName = "Maria Garcia", CraftsmanRating = 5.0, Price = 120, Excerpt = "\"Expert in all types of sink repairs. I can come by this afternoon to take a look and fix it on the spot.\"", ProposalUrl = "#", ProfileUrl = "#" }
            },
            InboxPreview = new List<InboxMessageVM>
            {
                new InboxMessageVM { Id = 1, SenderName = "Alex Johnson", Excerpt = "Sounds great! I'll send over the final designs by the end of the day.", ReceivedTime = "10:45 AM", IsRead = false, IsSupportTicket = false, SenderAvatarInitials = "AJ" },
                new InboxMessageVM { Id = 2, SenderName = "John Smith", Excerpt = "I've received the payment. Thank you!", ReceivedTime = "Yesterday", IsRead = true, IsSupportTicket = false, SenderAvatarInitials = "JS" },
                new InboxMessageVM { Id = 3, SenderName = "Support Team", Excerpt = "We've updated our terms of service. Please review them.", ReceivedTime = "2 days ago", IsRead = true, IsSupportTicket = true, SenderAvatarInitials = "ST" }
            }
        };
    }
}
