@page "/projects/available"
@using Core.SharedKernel.DTOs
@using CraftConnect.WASM.Components.AvailableProjectsPageComponents
@using CraftConnect.WASM.Components.SharedComponents
@using CraftConnect.WASM.ViewModels
@inject IHttpClientFactory HttpClientFactory
@inject ILoggerFactory LoggerFactory

<DashboardNavbar />

<div class="main-dashboard-container">
    <FilterSidebar @bind-SearchParameters="SearchParameters" OnApplyFilters="LoadProjectsAsync" />

    <div class="results-area">
        <div class="results-header">
            <h1>Find Your Next Project</h1>
            <p>Browse through opportunities posted by clients.</p>
            <div class="sort-control">
                <label>Sort by:</label>
                <select @bind="SearchParameters.SortBy">
                    <option value="Newest">Newest</option>
                    <option value="Deadline">Deadline</option>
                    <option value="Budget">Budget (High)</option>
                </select>
            </div>
        </div>

        @if (IsLoading)
        {
            <p class="loading-message">Fetching new projects...</p>
        }
        else if(!Projects.Any() && SearchParameters.PageNumber > 1)
        {
            <div class="no-results">
                <p>You have reached the end of the results.</p>
                <button class="btn-primary-action" @onclick="async () => { SearchParameters.PageNumber = 1; await LoadProjectsAsync(); }">Return to First Page</button>
            </div>
        }
        else if (Projects.Any())
        {
            <div class="projects-grid">
                @foreach (var project in Projects)
                {
                    <ProjectCard Project="@project" />
                }
            </div>
            <Pagination CurrentPage="@SearchParameters.PageNumber"
                        TotalPages="@TotalPages"
                        OnPageChange="HandlePageChange" />
        }
        else
        {
            <p class="no-results">No projects match your current filters.</p>
        }
    </div>
</div>

@code {
    private List<ProjectViewModel> Projects { get; set; } = new();
    private ProjectSearchParameters SearchParameters { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private ILogger Logger => LoggerFactory.CreateLogger<AvailableProjects>();

    private int TotalItems = 0;
    private int PageSize = 10;
    private int TotalPages => (int)Math.Ceiling((double)TotalItems / PageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadProjectsAsync();
    }

    private async Task HandlePageChange(int page)
    {
        SearchParameters.PageNumber = page;
        await LoadProjectsAsync();
    }

    private async Task ClearFilters()
    {
        SearchParameters = new(); // Reset
        await LoadProjectsAsync();
    }

    private async Task LoadProjectsAsync()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            var client = HttpClientFactory.CreateClient("BFF");

            // Build Query String manually or use a helper
            var query = $"/customerprojects/search?searchTerm={SearchParameters.Keyword}&pageNumber={SearchParameters.PageNumber}&pageSize={PageSize}";

            // Call API
            var response = await client.GetAsync(query);

            if (response.IsSuccessStatusCode)
            {
                var dtos = await response.Content.ReadFromJsonAsync<List<CustomerProjectResponseDTO>>();

                if (dtos != null)
                {
                    TotalItems = dtos.Count < PageSize ? dtos.Count : 100;

                    Projects = dtos.Select(MapToViewModel).ToList();
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Error loading projects: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private ProjectViewModel MapToViewModel(CustomerProjectResponseDTO dto)
    {
        return new ProjectViewModel
        {
            Id = dto.Id,
            Title = dto.Title,
            Description = dto.Description,
            UserAvatarUrl = dto.CustomerAvatarUrl ?? "/images/default-user.png", // Need to add to DTO
            BudgetRange = $"${dto.Budget.Amount} {dto.Budget.Currency}",
            Deadline = dto.Timeline.End.ToString("MMM dd, yyyy"),
            Location = dto.Location,
            Tags = dto.Skills.Select(s => s.Name).Take(3).ToList()
        };
    }

    // Parameters Class (Kept in same file or moved to ViewModels)
    public class ProjectSearchParameters
    {
        public string Keyword { get; set; } = string.Empty;
        public string SortBy { get; set; } = "Newest";
        public int PageNumber { get; set; } = 1;
        public List<string> Skills { get; set; } = new();
        public decimal? MinBudget { get; set; }
        public decimal? MaxBudget { get; set; }
        public DateTime? Deadline { get; set; }
        public string? Location { get; set; }
    }
}