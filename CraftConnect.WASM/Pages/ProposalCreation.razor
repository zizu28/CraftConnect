@page "/proposal/create/{ProjectId:guid}"
@using Blazored.FluentValidation
@using Core.SharedKernel.DTOs
@using CraftConnect.WASM.Validators
@using CraftConnect.WASM.ViewModels
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject NavigationManager NavManager
@inject IHttpClientFactory HttpClientFactory
@inject ILogger<ProposalCreation> Logger

<div class="proposal-page-container">
    @if (isLoadingProject)
    {
        <p>Loading project details...</p>
    }
    else if (projectDetails == null)
    {
        <div class="alert alert-danger">Project not found.</div>
    }
    else
    {
        <div class="header-actions-bar">
            <div class="header-info">
                <h1>Create Proposal: @projectDetails.Title</h1>
                <p class="project-by-line">Budget: $@projectDetails.Budget?.Amount @projectDetails.Budget?.Currency</p>
            </div>
        </div>

        <EditForm Model="@ProposalData" OnValidSubmit="HandleValidSubmit" class="proposal-form">
            <FluentValidationValidator Validator="@Validator" />
            <ValidationSummary />

            <div class="overview-box card-section">
                <h4 class="section-title">Project Overview</h4>
                <p class="section-subtitle">@projectDetails.Description</p>
            </div>

            <div class="solution-section card-section">
                <h4 class="section-title">Your Proposal</h4>
                <label>Cover Letter</label>
                <InputTextArea @bind-Value="ProposalData.CoverLetter" class="form-control" rows="5" placeholder="Describe your approach..." />
                <ValidationMessage For="@(() => ProposalData.CoverLetter)" />
            </div>

            <div class="pricing-section card-section">
                <h4 class="section-title">Pricing</h4>
                <div class="proposed-cost-input">
                    <label>Proposed Cost (@ProposalData.PriceCurrency)</label>
                    <InputNumber @bind-Value="ProposalData.PriceAmount" class="form-control" />
                    <ValidationMessage For="@(() => ProposalData.PriceAmount)" />
                </div>
            </div>

            <div class="timeline-section card-section">
                <h4 class="section-title">Timeline</h4>
                <div class="form-row-2col">
                    <div>
                        <label>Start Date</label>
                        <InputDate @bind-Value="ProposalData.StartDate" class="form-control" />
                        <ValidationMessage For="@(() => ProposalData.StartDate)" />
                    </div>
                    <div>
                        <label>End Date</label>
                        <InputDate @bind-Value="ProposalData.EndDate" class="form-control" />
                        <ValidationMessage For="@(() => ProposalData.EndDate)" />
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="bottom-actions-bar">
                <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
                <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                    @(isSubmitting ? "Submitting..." : "Submit Proposal")
                </button>
            </div>
        </EditForm>
    }
</div>

@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthStateTask { get; set; }

    [Parameter] 
    public Guid ProjectId { get; set; }
    public Guid CraftsmanId { get; set; }

    private ProposalCreationVM ProposalData { get; set; } = new();
    private CustomerProjectResponseDTO? projectDetails { get; set; }
    private ProposalCreationValidator Validator = new();

    private bool isLoadingProject = true;
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        CraftsmanId = await GetCraftsmanId();
        try
        {
            var client = HttpClientFactory.CreateClient("BFF");
            projectDetails = await client.GetFromJsonAsync<CustomerProjectResponseDTO>($"/customerprojects/{ProjectId}");

            ProposalData.ProjectId = ProjectId;
            ProposalData.StartDate = DateTime.Today;
            ProposalData.EndDate = DateTime.Today.AddDays(7);
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to load project: {ex.Message}");
        }
        finally
        {
            isLoadingProject = false;
        }
    }

    private async Task HandleValidSubmit()
    {
        if (isSubmitting) return;
        isSubmitting = true;

        try
        {
            var client = HttpClientFactory.CreateClient("BFF");

            var payload = new CreateCraftsmanProposalDTO
            {
                ProjectId = ProposalData.ProjectId,
                CoverLetter = ProposalData.CoverLetter,
                Price = new MoneyDTO{ Amount = ProposalData.PriceAmount, Currency = ProposalData.PriceCurrency },
                ProposedTimeline = new DateTimeRangeDTO{ Start = ProposalData.StartDate, End = ProposalData.EndDate }
            };

            var response = await client.PostAsJsonAsync("/craftsmanproposals/submit-proposal", payload);

            if (response.IsSuccessStatusCode)
            {
                Logger.LogInformation("Proposal submitted!");
                NavManager.NavigateTo($"/craftsman/{CraftsmanId}/proposals");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Logger.LogError($"Submission failed: {error}");
                // Show error toast
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Error: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        NavManager.NavigateTo("/projects/available");
    }

    private async Task<Guid> GetCraftsmanId()
    {
        var authState = await AuthStateTask;
        var user = authState.User;
        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        return Guid.Parse(userId!);
    }
}