@page "/signup"
@layout AuthLayout
@inject NavigationManager NavigationManager
@inject ILogger<SignUp> logger
@inject IHttpClientFactory HttpClientFactory

@using System.ComponentModel.DataAnnotations
@using Blazored.FluentValidation
@using Core.SharedKernel.DTOs
@using CraftConnect.WASM.Components.SignUpPageComponents
@using CraftConnect.WASM.Layout
@using CraftConnect.WASM.Validators
@using CraftConnect.WASM.ViewModels
@using CraftConnect.WASM.Services

<div class="signup-card">
    <header class="signup-header">
        <h1>Join Our Community</h1>
        <p>Create an account to get started.</p>
    </header>

    <!-- User Type Toggle -->
    <UserTypeToggle SelectedType="@model.Role" OnToggle="OnUserTypeChanged" />

    <p class="toggle-description">
        @if (model.Role == "Craftman")
        {
            <span>Showcase your skills, connect with clients, and grow your business.</span>
        }
        else
        {
            <span>Find talented craftspeople, manage projects, and bring your ideas to life.</span>
        }
    </p>

    <!-- Sign-up Form -->
    <EditForm Model="model" OnValidSubmit="HandleValidSubmit" class="signup-form">
        <FluentValidationValidator Validator="@Validator" />

        <!-- Email -->
        <div class="form-group">
            <label for="email">Email Address</label>
            <InputText id="email" @bind-Value="model.Email" class="form-control" placeholder="you@example.com" />
            <ValidationMessage For="() => model.Email" />
        </div>

        <!-- Password -->
        <div class="form-group">
            <label for="password">Create Password</label>
            <div class="password-wrapper">
                <InputText id="password" @bind-Value="model.Password" type="@(showPassword ? "text" : "password")" class="form-control" placeholder="••••••••" />
                <button type="button" class="password-toggle-btn" @onclick="TogglePasswordVisibility" tabindex="-1">
                    <i class="bi @(showPassword ? "bi-eye" : "bi-eye-slash")"></i>
                </button>
            </div>
            <p class="field-hint">Min 8 chars, 1 uppercase, 1 special char.</p>
            <ValidationMessage For="() => model.Password" />
        </div>

        <!-- Confirm Password -->
        <div class="form-group">
            <label for="confirm-password">Confirm Password</label>
            <InputText id="confirm-password" @bind-Value="model.ConfirmPassword" type="password" class="form-control" placeholder="••••••••" />
            <ValidationMessage For="() => model.ConfirmPassword" />
        </div>

        <!-- Terms -->
        <div class="form-group-checkbox mt-3">
            <InputCheckbox id="terms" @bind-Value="model.AgreeToTerms" />
            <label for="terms">
                I agree to the <a href="/terms">Terms</a> and <a href="/privacy">Privacy Policy</a>.
            </label>
        </div>
        <ValidationMessage For="() => model.AgreeToTerms" />

        <!-- Error Message -->
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-circle-fill me-2"></i> @errorMessage
            </div>
        }

        <!-- Submit -->
        <button type="submit" class="btn-submit" disabled="@isLoading">
            @if (isLoading)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
                <span>Creating Account...</span>
            }
            else
            {
                <span>Create Account</span>
            }
        </button>
    </EditForm>

    <!-- Separator -->
    <div class="separator">Or sign up with</div>

    <!-- Social Logins -->
    <div class="social-login-group">
        <button class="btn-social">
            <img src="https://www.vectorlogo.zone/logos/github/github-icon.svg" alt="GitHub" />
            <span>GitHub</span>
        </button>
        <button class="btn-social">
            <img src="https://www.vectorlogo.zone/logos/google/google-icon.svg" alt="Google" />
            <span>Google</span>
        </button>
    </div>

    <!-- Log in Link -->
    <div class="login-link">
        Already have an account? <a href="/login">Log in</a>
    </div>
</div>

@code {
    [Inject] public SignupVMValidator Validator { get; set; } = default!;

    // 1. Use ONE model for the form
    private UserCreateDTO model { get; set; } = new()
    {
        Role = "Customer", // Default
        Email = "",
        Password = "",
        ConfirmPassword = "",
        AgreeToTerms = false
    };

    private bool showPassword = false;
    private bool isLoading = false;
    private string? errorMessage;

    private void OnUserTypeChanged(string newUserType)
    {
        model.Role = newUserType;
        errorMessage = null;
    }

    private void TogglePasswordVisibility() => showPassword = !showPassword;

    private async Task HandleValidSubmit()
    {
        if (isLoading) return;
        isLoading = true;
        errorMessage = null;

        try
        {
            var httpClient = HttpClientFactory.CreateClient("UserManagement");
            HttpResponseMessage response;

            if (model.Role == "Craftman")
            {
                var craftmanDto = new CraftmanCreateDTO
                {
                    Email = model.Email,
                    Password = model.Password,
                    ConfirmPassword = model.ConfirmPassword,
                    AgreeToTerms = model.AgreeToTerms,
                    Role = "Craftman"
                };
                response = await httpClient.PostAsJsonAsync("/api/users/register/craftman", craftmanDto);
            }
            else if (model.Role == "Customer")
            {
                var customerDto = new CustomerCreateDTO
                {
                    Email = model.Email,
                    Password = model.Password,
                    ConfirmPassword = model.ConfirmPassword,
                    AgreeToTerms = model.AgreeToTerms,
                    Role = "Customer"
                };
                response = await httpClient.PostAsJsonAsync("/api/users/register/customer", customerDto);
            }
            else
            {
                response = await httpClient.PostAsJsonAsync("/api/users/register/customer", model);
            }

            if (response.IsSuccessStatusCode)
            {
                logger.LogInformation($"User {model.Email} registered.");
                NavigationManager.NavigateTo($"/verify-email/{model.Email}");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = !string.IsNullOrWhiteSpace(errorContent)
                    ? errorContent
                    : "Registration failed.";
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Registration Error: {ex.Message}");
            errorMessage = "A network error occurred.";
        }
        finally
        {
            isLoading = false;
        }
    }
}