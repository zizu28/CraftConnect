@page "/signup"
@layout AuthLayout
@inject NavigationManager NavigationManager
@inject ILogger<SignUp> logger
@inject IHttpClientFactory HttpClientFactory
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@using Blazored.FluentValidation
@using Core.SharedKernel.DTOs
@using CraftConnect.WASM.Components.SignUpPageComponents
@using CraftConnect.WASM.Layout
@using CraftConnect.WASM.Validators
@using CraftConnect.WASM.ViewModels

<div class="signup-container">
    <header class="signup-header">
        <h1>Join Our Community of Creators and Customers</h1>
    </header>

    <!-- User Type Toggle -->
    <UserTypeToggle SelectedType="@model.Role" OnToggle="OnUserTypeChanged" />
    <p class="toggle-description">
        @if (model.Role == "Craftman")
        {
            <span>Showcase your skills, connect with clients, and grow your business.</span>
        }
        else if(model.Role == "Customer")
        {
            <span>Find talented craftspeople, manage projects, and bring your ideas to life.</span>
        }
    </p>

    <!-- Sign-up Form -->
    <EditForm Model="model" OnValidSubmit="HandleValidSubmit" FormName="registration-form" class="signup-form" Enhance>
        <FluentValidationValidator Validator="Validator" />
        
        <div class="form-group">
            <label for="email">Email Address</label>
            <InputText id="email" @bind-Value="model.Email" class="form-control" placeholder="Enter your email" />
            <ValidationMessage For="() => model.Email" />
        </div>

        <div class="form-group">
            <label for="password">Create Password</label>
            <div class="password-wrapper">
                <InputText id="password" @bind-Value="model.Password" type="@(showPassword ? "text" : "password")" class="form-control" placeholder="Enter your password" />
                <button type="button" class="password-toggle-btn" @onclick="TogglePasswordVisibility">
                    @if (showPassword)
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z" /><path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 0 1 0-1.18l.879-1.148a1.65 1.65 0 0 1 1.969-.608l.34.114A1.65 1.65 0 0 0 5.05 8.223l.54-1.217a1.65 1.65 0 0 1 1.58-1.074h.54a1.65 1.65 0 0 1 1.58 1.074l.54 1.217a1.65 1.65 0 0 0 1.212.874l.34-.114a1.65 1.65 0 0 1 1.969.608l.879 1.148a1.651 1.651 0 0 1 0 1.18l-.879 1.148a1.65 1.65 0 0 1-1.969.608l-.34-.114a1.65 1.65 0 0 0-1.212.874l-.54 1.217a1.65 1.65 0 0 1-1.58 1.074h-.54a1.65 1.65 0 0 1-1.58-1.074l-.54-1.217a1.65 1.65 0 0 0-1.212-.874l-.34.114a1.65 1.65 0 0 1-1.969-.608L.664 10.59Z" clip-rule="evenodd" /></svg>
                    }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.28 2.22a.75.75 0 0 0-1.06 1.06l14.5 14.5a.75.75 0 1 0 1.06-1.06l-1.745-1.745a10.029 10.029 0 0 0 3.3-4.632.75.75 0 0 0 0-.5c-1.583-3.483-4.654-6.002-8.25-6.002-1.764 0-3.407.59-4.79 1.579L3.28 2.22ZM7.5 7.5c0-1.38.86-2.554 2.067-2.923l.634.634a.75.75 0 0 0 1.06-1.06l-.633-.634A4.502 4.502 0 0 1 18.25 10c-1.583 3.483-4.654 6.002-8.25 6.002-1.207 0-2.34-.282-3.37-.778l-1.171 1.171a.75.75 0 1 0 1.06 1.06l1.17-1.17a10.029 10.029 0 0 0 2.24.44c3.596 0 6.667-2.519 8.25-6.002a.75.75 0 0 0 0-.5c-.322-.705-.69-1.382-1.103-2.022l-1.507 1.507a2.983 2.983 0 0 0-3.39-3.39L7.5 7.5Z" clip-rule="evenodd" /></svg>
                    }
                </button>
            </div>
            <span class="field-hint">
                Password must have at least 8 characters, 1 uppercase, " +
                "1 lowercase, 1 special character and 1 number
            </span>
            <ValidationMessage For="() => model.Password" />
        </div>
        
        <div class="form-group">
            <label for="confirm-password">Confirm Password</label>
            <InputText id="confirm-password" @bind-Value="model.ConfirmPassword" type="password" class="form-control" placeholder="Confirm your password" />
            <ValidationMessage For="() => model.ConfirmPassword" />
        </div>

        <div class="form-group-checkbox">
            <InputCheckbox id="terms" @bind-Value="model.AgreeToTerms" />
            <label for="terms">
                I agree to the <a href="/terms">Terms of Service</a> and <a href="/privacy">Privacy Policy</a>.
            </label>            
        </div>
        <ValidationMessage For="() => model.AgreeToTerms" />

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">
                @errorMessage
            </div>
        }

        <button type="submit" class="btn-submit" disabled="@isLoading">
            @if (isLoading)
            {
                <span class="spinner"></span>
                <span>Creating Account</span>
            }
            else
            {
                <span>Create Account</span>
            }
        </button>
    </EditForm>

    <!-- Separator -->
    <div class="separator">OR</div>

    <!-- Social Logins -->
    <div class="social-login-group">
        <button class="btn-social">
            <img src="https://www.vectorlogo.zone/logos/google/google-icon.svg" alt="Google" />
            <span>Sign up with Google</span>
        </button>
        <button class="btn-social">
            <img src="https://www.vectorlogo.zone/logos/github/github-icon.svg" alt="Github" />
            <span>Sign up with Github</span>
        </button>
    </div>

    <!-- Log in Link -->
    <div class="login-link">
        Already have an account? <a href="/login">Log in</a>
    </div>

</div>

@code {
    public SignupVMValidator Validator { get; set; } = new();
    private UserCreateDTO model { get; set; } = new()
    {
        Email = string.Empty,
        Password = string.Empty,
        ConfirmPassword = string.Empty,
        Role = string.Empty,
        AgreeToTerms = false
    };
    private bool showPassword = false;
    private bool isLoading = false;
    private HttpResponseMessage userResponse { get; set; } = default!;
    private string? errorMessage;

    private void OnUserTypeChanged(string newUserType)
    {
        model.Role = newUserType;
        errorMessage = null;
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private async Task HandleValidSubmit()
    {
        if(isLoading) return;
        isLoading = true;
        errorMessage = null;
        try
        {
            var httpClient = HttpClientFactory.CreateClient("UserManagement");
            userResponse = model.Role switch
            {
                "Craftman" => await httpClient.PostAsJsonAsync("/api/users/register/craftman", model),
                "Customer" => await httpClient.PostAsJsonAsync("/api/users/register/customer", model),
                _ => await httpClient.PostAsJsonAsync("/api/users/register", model)
            };
            
            if (userResponse.IsSuccessStatusCode)
            {
                logger.LogInformation($"User with email {model.Email} has successfully registered");
                NavigationManager.NavigateTo($"/verify-email/{model.Email}");
            }
            else
            {
                var errorContent = await userResponse.Content.ReadAsStringAsync();
                errorMessage = !string.IsNullOrWhiteSpace(errorContent)
                    ? errorContent
                    : "Registration failed. Please try again.";
                logger.LogWarning($"Registration failed: {errorMessage}");
            }
        }
        catch(Exception ex)
        {
            logger.LogError($"Network error during registration: {ex.Message}");
            errorMessage = "A network error occurred.";
        }
        finally
        {
            isLoading = false;
        }
    }
}
