@page "/login"
@layout LoginLayout
@inject IHttpClientFactory HttpClientFactory
@inject ILogger<Login> logger
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@using Blazored.FluentValidation
@using CraftConnect.WebUI.Auth
@using CraftConnect.WebUI.Components.Layout
@using System.Security.Claims
@using System.Text.Json
@using CraftConnect.WebUI.DTOs
@using Microsoft.AspNetCore.Components.Authorization

<div class="login-card">
    <header class="login-card-header">
        <h2>Welcome Back</h2>
        <p>Log in to your account to continue.</p>
    </header>

    <!-- Login Form -->
    <EditForm Model="model" OnValidSubmit="HandleValidSubmit" class="login-form" Enhance>
        <FluentValidationValidator Validator="@Validator" />

        <div class="form-group">
            <label for="email">Email or Username</label>
            <InputText id="email" @bind-Value="model.Email" class="form-control" placeholder="Enter your email or username" />
            <ValidationMessage For="() => model.Email" />
        </div>

        <div class="form-group">
            <div class="label-row">
                <label for="password">Password</label>
                <a href="/forgot-password" class="link-forgot">Forgot Password?</a>
            </div>
            <div class="password-wrapper">
                <InputText id="password" @bind-Value="model.Password" type="@(showPassword ? "text" : "password")" class="form-control" placeholder="Enter your password" />
                <button type="button" class="password-toggle-btn" @onclick="TogglePasswordVisibility">
                    @if (showPassword)
                    {
                        <!-- Eye icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z" /><path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 0 1 0-1.18l.879-1.148a1.65 1.65 0 0 1 1.969-.608l.34.114A1.65 1.65 0 0 0 5.05 8.223l.54-1.217a1.65 1.65 0 0 1 1.58-1.074h.54a1.65 1.65 0 0 1 1.58 1.074l.54 1.217a1.65 1.65 0 0 0 1.212.874l.34-.114a1.65 1.65 0 0 1 1.969.608l.879 1.148a1.651 1.651 0 0 1 0 1.18l-.879 1.148a1.65 1.65 0 0 1-1.969.608l-.34-.114a1.65 1.65 0 0 0-1.212.874l-.54 1.217a1.65 1.65 0 0 1-1.58 1.074h-.54a1.65 1.65 0 0 1-1.58-1.074l-.54-1.217a1.65 1.65 0 0 0-1.212-.874l-.34.114a1.65 1.65 0 0 1-1.969-.608L.664 10.59Z" clip-rule="evenodd" /></svg>
                    }
                    else
                    {
                        <!-- Eye-slash icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.28 2.22a.75.75 0 0 0-1.06 1.06l14.5 14.5a.75.75 0 1 0 1.06-1.06l-1.745-1.745a10.029 10.029 0 0 0 3.3-4.632.75.75 0 0 0 0-.5c-1.583-3.483-4.654-6.002-8.25-6.002-1.764 0-3.407.59-4.79 1.579L3.28 2.22ZM7.5 7.5c0-1.38.86-2.554 2.067-2.923l.634.634a.75.75 0 0 0 1.06-1.06l-.633-.634A4.502 4.502 0 0 1 18.25 10c-1.583 3.483-4.654 6.002-8.25 6.002-1.207 0-2.34-.282-3.37-.778l-1.171 1.171a.75.75 0 1 0 1.06 1.06l1.17-1.17a10.029 10.029 0 0 0 2.24.44c3.596 0 6.667-2.519 8.25-6.002a.75.75 0 0 0 0-.5c-.322-.705-.69-1.382-1.103-2.022l-1.507 1.507a2.983 2.983 0 0 0-3.39-3.39L7.5 7.5Z" clip-rule="evenodd" /></svg>
                    }
                </button>
            </div>
            <ValidationMessage For="() => model.Password" />
        </div>

        <div class="form-group-checkbox">
            <InputCheckbox id="remember" @bind-Value="model.RememberMe" />
            <label for="remember">Remember Me</label>
        </div>

        <button type="submit" class="btn-submit" disabled="@IsLoading">
            @if (IsLoading)
            {
                <span class="spinner"></span>
                <span>Logging in...</span>
            }
            else
            {
                <span>Log in</span>
            }
        </button>
    </EditForm>

    <!-- Separator -->
    <div class="separator">Or log in with</div>

    <!-- Social Logins -->
    <div class="social-login-group">
        <button class="btn-social">
            <img src="https://www.vectorlogo.zone/logos/github/github-icon.svg" alt="GitHub" />
        </button>
        <button class="btn-social">
            <img src="https://www.vectorlogo.zone/logos/google/google-icon.svg" alt="Google" />
        </button>
    </div>

    <!-- Sign Up Link -->
    <div class="signup-link">
        Don't have an account? <a href="/signup">Sign Up</a>
    </div>
</div>

@code {
    public LoginVMValidator Validator { get; set; } = new();
    private LoginUserCommand model = new();
    private bool showPassword = false;
    private string userRole = "";
    private UserResponseDTO? user { get; set; }
    private bool IsLoading = false;

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    public class LoginResponse
    {
        public string AccessToken { get; set; } = string.Empty;
        public string RefreshToken { get; set; } = string.Empty;
    }

    private async Task HandleValidSubmit()
    {
        if (IsLoading) return;
        IsLoading = true;
        try
        {
            var httpClient = HttpClientFactory.CreateClient("Backend");
            HttpResponseMessage response = await httpClient.PostAsJsonAsync("/api/users/signin", model, new JsonSerializerOptions
            {
                WriteIndented = true
            });
            if (response.IsSuccessStatusCode)
            {
                // user = await httpClient.GetFromJsonAsync<UserResponseDTO>($"/api/users/by-email/{model.Email}");
                // var tokenResponse = await response.Content.ReadFromJsonAsync<LoginResponse>();
                // if (tokenResponse != null && !string.IsNullOrEmpty(tokenResponse.AccessToken) && !string.IsNullOrEmpty(tokenResponse.RefreshToken))
                // {
                //     var claims = JwtParser.ParseClaimsFromJwt(tokenResponse.AccessToken);
                //     var roleClaim = claims.FirstOrDefault(c => c.Type == "role" || c.Type == ClaimTypes.Role);
                //     if(roleClaim != null)
                //     {
                //         userRole = roleClaim.Value;
                //     }
                // }
                var userInfo = await response.Content.ReadFromJsonAsync<UserResponseDTO>();
                var customAuthStateProvider = (BffAuthenticationStateProvider)AuthStateProvider;                
                
                if (userInfo != null)
                {
                    customAuthStateProvider.NotifyUserLoggedIn(userInfo);
                    if (userInfo.Role == "Customer")
                    {
                        NavigationManager.NavigateTo($"/customer/{userInfo.UserId}/dashboard");
                    }
                    else if (userInfo.Role == "Craftman")
                    {
                        NavigationManager.NavigateTo($"/dashboard/{userInfo.UserId}");
                    }
                    else if (userInfo.Role == "Admin")
                    {
                        NavigationManager.NavigateTo("/admin/dashboard");
                    }
                }
                logger.LogInformation($"User with email {model.Email} has successfully logged in");
            }
            else
            {
                logger.LogInformation($"Error logging in.");
            }
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error logging in user. Error: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }
}
