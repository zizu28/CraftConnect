@page "/craftsman/earnings"
@layout EarningsLayout
@using CraftConnect.WebUI.Components.EarningsAndPaymentsPageComponents
@using CraftConnect.WebUI.Components.Layout
@using CraftConnect.WebUI.Enums

<div class="page-header">
    <h1>Earnings & Payments</h1>
    <button class="btn btn-export">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.418a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 2.946V2.75Z" />
            <path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5a1.25 1.25 0 0 1-1.25 1.25H4.75A1.25 1.25 0 0 1 3.5 15.25v-2.5Z" />
        </svg>
        Export Statement
    </button>
</div>

<!-- Stat Cards -->
<div class="stat-grid">
    <EarningStatCard Title="Total Earnings to Date" Value="@stats.TotalEarningsToDate.ToString("C")" />
    <EarningStatCard Title="Earnings This Month" Value="@stats.EarningsThisMonth.ToString("C")" />
    <EarningStatCard Title="Pending Payouts" Value="@stats.PendingPayouts.ToString("C")" IsPending="true" />
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="search-container">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11zM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 1 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9z" clip-rule="evenodd" />
        </svg>
        <input type="text" placeholder="Search transactions..." @bind="searchTerm" />
    </div>
    <div class="filter-dropdowns">
        <select @bind="dateFilter">
            <option value="">Filter by Date</option>
            <option value="last-30">Last 30 days</option>
            <option value="this-month">This Month</option>
            <option value="last-month">Last Month</option>
        </select>
        <select @bind="projectFilter">
            <option value="">Filter by Project</option>
            <option value="project-1">Kitchen Renovation</option>
            <option value="project-2">Living Room Painting</option>
        </select>
    </div>
</div>

<!-- Transactions Table -->
<TransactionTable Transactions="FilteredTransactions" />

<!-- Pagination -->
<div class="pagination-footer">
    <span>Showing <strong>@StartItem</strong> to <strong>@EndItem</strong> of <strong>@TotalItemCount</strong> results</span>
    <EarningsPagination CurrentPage="currentPage" TotalPages="TotalPages" OnPageChanged="HandlePageChange" />
</div>

@code {
    private CraftsmanEarningStats stats = new();
    private List<CraftsmanTransaction> allTransactions = new();

    private string searchTerm = "";
    private string dateFilter = "";
    private string projectFilter = "";
    private int currentPage = 1;
    private int pageSize = 5;

    private List<CraftsmanTransaction> FilteredTransactions
    {
        get
        {
            var items = allTransactions.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                items = items.Where(i => 
                    i.Project.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) || 
                    i.Client.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
            }
            // Add date and project filter logic here
            if (!string.IsNullOrWhiteSpace(dateFilter))
            {
                var now = DateTime.UtcNow;
                items = dateFilter.ToLower() switch
                {
                    "last-30" => items.Where(i => (now - i.Date).TotalDays <= 30),
                    "this-month" => items.Where(i => (now - i.Date).TotalDays <= 30),
                    "last-month" => items.Where(i => (now - i.Date).TotalDays <= 60),
                    _ => items
                };
            }

            if (!string.IsNullOrWhiteSpace(projectFilter))
            {
                items = projectFilter.ToLower() switch
                {
                    "project-1" => items.Where(i => i.Project.Contains("Kitchen Renovation", StringComparison.OrdinalIgnoreCase)),
                    "project-2" => items.Where(i => i.Project.Contains("Living Room Painting", StringComparison.OrdinalIgnoreCase)),
                    _ => items
                };
            }

            return items.ToList();
        }
    }

    private int TotalItemCount => FilteredTransactions.Count;
    private int TotalPages => (int)Math.Ceiling(TotalItemCount / (double)pageSize);
    private int StartItem => TotalItemCount == 0 ? 0 : (currentPage - 1) * pageSize + 1;
    private int EndItem => Math.Min(currentPage * pageSize, TotalItemCount);
    
    private List<CraftsmanTransaction> PaginatedTransactions => FilteredTransactions
        .Skip((currentPage - 1) * pageSize)
        .Take(pageSize)
        .ToList();

    protected override void OnInitialized()
    {
        // Mock data from image
        stats = new CraftsmanEarningStats
        {
            TotalEarningsToDate = 12450.00m,
            EarningsThisMonth = 1200.00m,
            PendingPayouts = 500.00m
        };

        allTransactions = new List<CraftsmanTransaction>
        {
            new CraftsmanTransaction { Id = Guid.NewGuid(), Date = new DateTime(2025, 10, 26), Project = "Kitchen Renovation", Client = "John Doe", Amount = 2500.00m, PaymentMethod = "Credit Card", Status = TransactionStatus.Paid },
            new CraftsmanTransaction { Id = Guid.NewGuid(), Date = new DateTime(2025, 10, 22), Project = "Living Room Painting", Client = "Jane Smith", Amount = 800.00m, PaymentMethod = "Bank Transfer", Status = TransactionStatus.Paid },
            new CraftsmanTransaction { Id = Guid.NewGuid(), Date = new DateTime(2025, 10, 18), Project = "Custom Bookshelf", Client = "Peter Jones", Amount = 1200.00m, PaymentMethod = "Credit Card", Status = TransactionStatus.Paid },
            new CraftsmanTransaction { Id = Guid.NewGuid(), Date = new DateTime(2025, 10, 15), Project = "Bathroom Tiling", Client = "Mary Williams", Amount = 1500.00m, PaymentMethod = "Bank Transfer", Status = TransactionStatus.Pending },
            new CraftsmanTransaction { Id = Guid.NewGuid(), Date = new DateTime(2025, 10, 10), Project = "Garden Landscaping", Client = "David Brown", Amount = 3000.00m, PaymentMethod = "Credit Card", Status = TransactionStatus.Paid }
            // Add more items to test pagination
        };
    }

    private void HandlePageChange(int newPage)
    {
        currentPage = newPage;
    }
}