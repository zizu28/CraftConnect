@page "/reset-password"
@layout ResetPasswordLayout
@inject IHttpClientFactory httpClientFactory
@inject NavigationManager NavigationManager
@inject ILoggerFactory loggerFactory
@using CraftConnect.WebUI.Components.Layout
@using CraftConnect.WebUI.Components.ResetPasswordPageComponents
@inject IJSRuntime JSRuntime

<div class="reset-password-card">
    <EditForm Model="model" OnValidSubmit="HandleResetPassword" OnFieldChanged="OnFieldChanged">
        <DataAnnotationsValidator />

        <div class="card-header">
            <h2>Reset Your Password</h2>
            <p>Please enter and confirm your new password below.</p>
        </div>

        <div class="form-group">
            <label for="new-password">New Password</label>
            <div class="password-wrapper">
                <InputText id="new-password" type="@newPasswordInputType" class="form-control" @bind-Value="model.NewPassword" placeholder="Enter your new password" />
                <button type="button" class="toggle-password" @onclick="@(() => TogglePasswordVisibility("new"))">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        @if (newPasswordInputType == "password")
                        {
                            <path d="M10 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z" />
                            <path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 0 1 0-1.18l.88-1.84a1.75 1.75 0 0 1 1.693-.9C5.618 6.55 7.954 6 10 6c2.046 0 4.382.55 6.763 1.67a1.75 1.75 0 0 1 1.693.9l.88 1.84c.33.69-.023 1.537-.732 1.732l-.006.002s-.003.001-.005.001L18.8 15.34a1.75 1.75 0 0 1-2.27 1.403 10.4 10.4 0 0 0-13.06 0 1.75 1.75 0 0 1-2.27-1.403l-.158-3.155Zm1.33 1.113a.75.75 0 0 1 .18-1.036L3.6 9.844a.75.75 0 0 1 1.036.18c.597.8 1.479 1.52 2.5 2.093a.75.75 0 0 1-.5 1.34c-1.27-.66-2.317-1.54-3.04-2.34ZM10 9a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z" clip-rule="evenodd" />
                        }
                        else
                        {
                            <path fill-rule="evenodd" d="M3.28 2.22a.75.75 0 0 0-1.06 1.06l14.5 14.5a.75.75 0 1 0 1.06-1.06l-1.749-1.749a10.025 10.025 0 0 0 1.928-3.924C18.6 10.233 14.6 6 10 6c-1.57 0-3.042.5-4.32 1.32L3.28 2.22ZM7.06 8.357a.75.75 0 0 0-1.06-1.06L4.352 8.94a1.75 1.75 0 0 0 0 2.121l.002.002a1.75 1.75 0 0 0 2.475 0l.002-.002a.75.75 0 0 0-1.06-1.06L5.394 9.6l.001-.001a.25.25 0 0 1 .354 0l.001.001l.33.33a.25.25 0 0 1 0 .354l-.001.001l-.33.33a.25.25 0 0 1-.354 0l-.001-.001L4.606 10l-.001.001a.75.75 0 0 0-1.06 1.06l.001-.001a1.75 1.75 0 0 0 2.474 0l.001-.001L7.06 9.418l-.001.001a.75.75 0 0 0 0-1.06Zm-3.07-.02a1.75 1.75 0 0 0-2.474 0l.001.001L1.16 8.94a1.75 1.75 0 0 0 0 2.121l.001.001a1.75 1.75 0 0 0 2.475 0l.001-.001l.353-.354a.25.25 0 0 0 0-.354l-.001-.001l-.33-.33a.25.25 0 0 0-.354 0l-.001.001l-.33.33a.25.25 0 0 0 0 .354l.001.001l.353.354a.75.75 0 0 0 1.06-1.06l-.001.001L3.6 9.844l.001-.001a.25.25 0 0 0 0-.354l-.001-.001l.353-.354l.001-.001ZM14.94 11.06a.75.75 0 0 0 1.06-1.06l-1.647-1.647a.75.75 0 0 0-1.06 1.06l1.647 1.647ZM10.5 10.5a.5.5 0 0 0 0-1h-1a.5.5 0 0 0 0 1h1Z" clip-rule="evenodd" />
                            <path d="M10 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5ZM12.94 14.94a4.01 4.01 0 0 1-5.88 0l-1.06-1.06a.75.75 0 0 0-1.06 1.06l1.06 1.06a5.51 5.51 0 0 0 7.92 0l1.06-1.06a.75.75 0 0 0-1.06-1.06l-1.06 1.06Z" />
                        }
                    </svg>
                </button>
            </div>
            <ValidationMessage For="@(() => model.NewPassword)" />
        </div>

        <div class="form-group">
            <label for="confirm-password">Confirm New Password</label>
            <div class="password-wrapper">
                <InputText id="confirm-password" type="@confirmPasswordInputType" class="form-control" @bind-Value="model.ConfirmPassword" placeholder="Confirm your new password" />
                <button type="button" class="toggle-password" @onclick="@(() => TogglePasswordVisibility("confirm"))">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        @if (confirmPasswordInputType == "password")
                        {
                            <path d="M10 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z" />
                            <path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 0 1 0-1.18l.88-1.84a1.75 1.75 0 0 1 1.693-.9C5.618 6.55 7.954 6 10 6c2.046 0 4.382.55 6.763 1.67a1.75 1.75 0 0 1 1.693.9l.88 1.84c.33.69-.023 1.537-.732 1.732l-.006.002s-.003.001-.005.001L18.8 15.34a1.75 1.75 0 0 1-2.27 1.403 10.4 10.4 0 0 0-13.06 0 1.75 1.75 0 0 1-2.27-1.403l-.158-3.155Zm1.33 1.113a.75.75 0 0 1 .18-1.036L3.6 9.844a.75.75 0 0 1 1.036.18c.597.8 1.479 1.52 2.5 2.093a.75.75 0 0 1-.5 1.34c-1.27-.66-2.317-1.54-3.04-2.34ZM10 9a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z" clip-rule="evenodd" />
                        }
                        else
                        {
                            <path fill-rule="evenodd" d="M3.28 2.22a.75.75 0 0 0-1.06 1.06l14.5 14.5a.75.75 0 1 0 1.06-1.06l-1.749-1.749a10.025 10.025 0 0 0 1.928-3.924C18.6 10.233 14.6 6 10 6c-1.57 0-3.042.5-4.32 1.32L3.28 2.22ZM7.06 8.357a.75.75 0 0 0-1.06-1.06L4.352 8.94a1.75 1.75 0 0 0 0 2.121l.002.002a1.75 1.75 0 0 0 2.475 0l.002-.002a.75.75 0 0 0-1.06-1.06L5.394 9.6l.001-.001a.25.25 0 0 1 .354 0l.001.001l.33.33a.25.25 0 0 1 0 .354l-.001.001l-.33.33a.25.25 0 0 1-.354 0l-.001-.001L4.606 10l-.001.001a.75.75 0 0 0-1.06 1.06l.001-.001a1.75 1.75 0 0 0 2.474 0l.001-.001L7.06 9.418l-.001.001a.75.75 0 0 0 0-1.06Zm-3.07-.02a1.75 1.75 0 0 0-2.474 0l.001.001L1.16 8.94a1.75 1.75 0 0 0 0 2.121l.001.001a1.75 1.75 0 0 0 2.475 0l.001-.001l.353-.354a.25.25 0 0 0 0-.354l-.001-.001l-.33-.33a.25.25 0 0 0-.354 0l-.001.001l-.33.33a.25.25 0 0 0 0 .354l.001.001l.353.354a.75.75 0 0 0 1.06-1.06l-.001.001L3.6 9.844l.001-.001a.25.25 0 0 0 0-.354l-.001-.001l.353-.354l.001-.001ZM14.94 11.06a.75.75 0 0 0 1.06-1.06l-1.647-1.647a.75.75 0 0 0-1.06 1.06l1.647 1.647ZM10.5 10.5a.5.5 0 0 0 0-1h-1a.5.5 0 0 0 0 1h1Z" clip-rule="evenodd" />
                            <path d="M10 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5ZM12.94 14.94a4.01 4.01 0 0 1-5.88 0l-1.06-1.06a.75.75 0 0 0-1.06 1.06l1.06 1.06a5.51 5.51 0 0 0 7.92 0l1.06-1.06a.75.75 0 0 0-1.06-1.06l-1.06 1.06Z" />
                        }
                    </svg>
                </button>
            </div>
            <ValidationMessage For="@(() => model.ConfirmPassword)" />
        </div>

        <PasswordStrength Password="@model.NewPassword" />

        <button type="submit" class="btn btn-primary btn-block">Update Password</button>

    </EditForm>

    <div class="card-footer">
        <a href="/help">Help</a>
        <span>|</span>
        <a href="/contact">Contact Us</a>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string Email { get; set; } = string.Empty;
    [SupplyParameterFromQuery]
    public string Token { get; set; } = string.Empty;
    private ChangePasswordCommand model { get; set; } = new();
    private string newPasswordInputType = "password";
    private string confirmPasswordInputType = "password";
    private bool isLoading = false;
    private string? errorMessage;
    private ILogger logger = default!;

    protected override Task OnInitializedAsync()
    {
        logger = loggerFactory.CreateLogger<ResetPassword>();
        if (string.IsNullOrEmpty(Email) || string.IsNullOrEmpty(Token))
        {
            errorMessage = "Invalid password reset link.";
        }
        return base.OnInitializedAsync();
    }

    private async Task HandleResetPassword()
    {
        if (isLoading) return;
        isLoading = true;
        errorMessage = null;
        try
        {
            model.Email = Email;
            model.Token = Token;
            var client = httpClientFactory.CreateClient("Backend");
            var response = await client.PostAsJsonAsync("/api/users/change-password", model);

            if (response.IsSuccessStatusCode)
            {
                logger.LogInformation($"Password reset for {Email}");
                NavigationManager.NavigateTo("/login");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = string.IsNullOrEmpty(error) ? "Failed to reset password." : error;
            }
        }
        catch(Exception ex)
        {
            logger.LogError(ex, "Reset password error");
            errorMessage = "An error occurred. Please try again.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnFieldChanged(FieldIdentifier field)
    {
        if (field.FieldName == nameof(model.NewPassword))
        {
            InvokeAsync(StateHasChanged);
        }
    }

    private void TogglePasswordVisibility(string field)
    {
        if (field == "new")
        {
            newPasswordInputType = (newPasswordInputType == "password") ? "text" : "password";
        }
        else if (field == "confirm")
        {
            confirmPasswordInputType = (confirmPasswordInputType == "password") ? "text" : "password";
        }
    }
}